import{_ as p}from"./TheArticle.d06fed8f.js";import{o as l,e as o}from"./vendor.a2cf0b24.js";import"./app.77d166c7.js";const F="In Rust We Bust",D="2022-04-01T00:00:00.000Z",C="comp",i=["rust","pl"],d={setup(e,{expose:n}){const s={title:"In Rust We Bust",date:"2022-04-01T00:00:00.000Z",category:"comp",tags:["rust","pl"]};return n({frontmatter:s}),(c,t)=>{const a=p;return l(),o(a,{frontmatter:s,inner:`<div><p>Rust \u8BED\u8A00\u7684\u8E29\u5751\u8BB0\u5F55\u3002</p>
<!-- more -->
<p><s>\u5BF9 <code>rustc</code> \u65BD\u7528 <a href="https://harrypotter.fandom.com/wiki/Silencing_Charm" target="_blank" rel="noopener"><code>Silencio</code></a> \u53EF\u4E0D\u80FD\u89E3\u51B3\u95EE\u9898</s>\u3002</p>
<h2 id="refcell-\u548C\u4F5C\u7528\u57DF" tabindex="-1"><code>RefCell</code> \u548C\u4F5C\u7528\u57DF</h2>
<p>Rust \u901A\u8FC7 <code>std::cell</code> \u63D0\u4F9B\u7684\u201C\u5185\u90E8\u53EF\u53D8\u6027\u201D\u770B\u8D77\u6765\u5F88\u723D\u2014\u2014\u53EF\u4EE5\u628A\u4E00\u4E2A\u4E0D\u53EF\u53D8\u7684\u6570\u636E\u7684\u4E00\u90E8\u5206\u641E\u6210\u53EF\u53D8\u7684\u3002\u5176\u4E2D\u7684 <code>RefCell</code> \u53EF\u4EE5\u628A<s>\u7F8E\u540D\u8FDC\u626C</s>\u7684\u7F16\u8BD1\u671F <code>borrowck</code> \u641E\u5230\u8FD0\u884C\u671F\u53BB\uFF0C\u5B9E\u73B0\u5F80\u4E0D\u53EF\u53D8\u6570\u636E\u5185\u90E8\u6307\u4E00\u4E2A\u53EF\u5199\u7684\u6307\u9488 <code>RefMut</code> \u7684\u529F\u80FD\u{1F917}\u3002</p>
<p>\u90A3\u4E48\u80FD\u4E0D\u80FD\u628A\u539F\u6570\u636E\u7528 <code>RefCell</code> \u4E00\u5305\uFF0C\u7136\u540E\u76F4\u63A5\u628A <code>&amp;x, &amp;mut x</code> \u66FF\u6362\u6210 <code>x.borrow(), x.borrow_mut()</code> \uFF1F\u7F16\u8BD1\u5668\u4F1A\u7B54\u5E94\uFF0C\u4F46\u4F5C\u7528\u57DF\u95EE\u9898\u53EF\u80FD\u4F1A\u5BFC\u81F4\u8FD0\u884C\u65F6 panic\u{1F643}\u3002</p>
<p>\u8003\u8651\u4E0B\u9762\u4E00\u6BB5\u4EE3\u7801\uFF1A</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #2e3440ff"><code><span class="line"><span style="color: #ECEFF4">#[</span><span style="color: #D8DEE9FF">allow</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">unused</span><span style="color: #ECEFF4">)]</span></span>
<span class="line"><span style="color: #81A1C1">fn</span><span style="color: #D8DEE9FF"> </span><span style="color: #88C0D0">main</span><span style="color: #ECEFF4">()</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">mut</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">x</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> Option</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">i32</span><span style="color: #ECEFF4">&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> None</span><span style="color: #ECEFF4">;</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">y</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">&amp;</span><span style="color: #D8DEE9">x</span><span style="color: #ECEFF4">;</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">if</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">y</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">is_none</span><span style="color: #ECEFF4">()</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">z</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">&amp;mut</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">x</span><span style="color: #ECEFF4">;</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #ECEFF4">}</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">#[allow(unused)]</span></span>
<span class="line"><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">main</span><span style="color: #24292F">() {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> </span><span style="color: #CF222E">mut</span><span style="color: #24292F"> x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">i32</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">None</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> y </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #24292F">x;</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">if</span><span style="color: #24292F"> y</span><span style="color: #CF222E">.</span><span style="color: #8250DF">is_none</span><span style="color: #24292F">() {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">let</span><span style="color: #24292F"> z </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F"> x;</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>\u95EE\u9898\u5168\u7136\u65E0\uFF0C\u7F16\u8BD1\u901A\u8FC7\u3002<code>y</code> \u662F\u4E0D\u53EF\u53D8\u5F15\u7528\uFF0C\u4F46\u662F\u5728 <code>if</code> \u7684\u8868\u8FBE\u5F0F\u91CC\u53EA\u7528\u8FC7\u4E00\u6B21\u5C31\u6CA1\u518D\u7528\u8FC7\uFF0C\u56E0\u6B64 <code>z</code> \u53EF\u4EE5\u9AD8\u9AD8\u5174\u5174\u5730\u501F\u51FA\u53EF\u53D8\u5F15\u7528\u3002\u770B\u770B MIR\uFF1A</p>
<pre><code class="language-sh"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #2e3440ff"><code><span class="line"><span style="color: #D8DEE9FF">$ rustc src/main.rs --emit mir</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">$ rustc src/main.rs --emit mir</span></span>
<span class="line"></span></code></pre></div></code></pre>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #2e3440ff"><code><span class="line"><span style="color: #D8DEE9">scope</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">1</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">debug</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">x</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_1</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">                   // in scope 1</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_2</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">&amp;</span><span style="color: #D8DEE9FF">std</span><span style="color: #81A1C1">::</span><span style="color: #D8DEE9FF">option</span><span style="color: #81A1C1">::</span><span style="color: #D8DEE9FF">Option</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">i32</span><span style="color: #ECEFF4">&gt;;</span><span style="color: #616E88"> // in scope 1</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">scope</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">2</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #D8DEE9">debug</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">y</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_2</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">               // in scope 2</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_5</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">&amp;mut</span><span style="color: #D8DEE9FF"> std</span><span style="color: #81A1C1">::</span><span style="color: #D8DEE9FF">option</span><span style="color: #81A1C1">::</span><span style="color: #D8DEE9FF">Option</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">i32</span><span style="color: #ECEFF4">&gt;;</span><span style="color: #616E88"> // in scope 2</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #D8DEE9">scope</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">3</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">            </span><span style="color: #D8DEE9">debug</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">z</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_5</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">           // in scope 3</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #ECEFF4">}</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #ECEFF4">}</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9">bb0</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #88C0D0">discriminant</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9">_1</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">0</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">            // scope 0</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">_2</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">&amp;</span><span style="color: #D8DEE9">_1</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">                        // scope 1</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">_4</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_2</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">                         // scope 2</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">_3</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> Option</span><span style="color: #81A1C1">::</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">i32</span><span style="color: #ECEFF4">&gt;</span><span style="color: #81A1C1">::</span><span style="color: #88C0D0">is_none</span><span style="color: #ECEFF4">(</span><span style="color: #81A1C1">move</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_4</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">-&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb1</span><span style="color: #ECEFF4">;</span><span style="color: #616E88"> // scope 2</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9">bb1</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #88C0D0">switchInt</span><span style="color: #ECEFF4">(</span><span style="color: #81A1C1">move</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_3</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">-&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">[</span><span style="color: #81A1C1">false:</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb3</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">otherwise</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb2</span><span style="color: #ECEFF4">];</span><span style="color: #616E88"> // scope 2</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9">bb2</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">_5</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">&amp;mut</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_1</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">                    // scope 2</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">goto</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">-&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb3</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">                     // scope 2</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9">bb3</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">return</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">                          // scope 0</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">scope </span><span style="color: #0550AE">1</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    debug x </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> _1;</span><span style="color: #6E7781">                   // in scope 1</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> _2</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #953800">std</span><span style="color: #CF222E">::</span><span style="color: #953800">option</span><span style="color: #CF222E">::</span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">i32</span><span style="color: #24292F">&gt;;</span><span style="color: #6E7781"> // in scope 1</span></span>
<span class="line"><span style="color: #24292F">    scope </span><span style="color: #0550AE">2</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">        debug y </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> _2;</span><span style="color: #6E7781">               // in scope 2</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">let</span><span style="color: #24292F"> _5</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F"> </span><span style="color: #953800">std</span><span style="color: #CF222E">::</span><span style="color: #953800">option</span><span style="color: #CF222E">::</span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">i32</span><span style="color: #24292F">&gt;;</span><span style="color: #6E7781"> // in scope 2</span></span>
<span class="line"><span style="color: #24292F">        scope </span><span style="color: #0550AE">3</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">            debug z </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> _5;</span><span style="color: #6E7781">           // in scope 3</span></span>
<span class="line"><span style="color: #24292F">        }</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">bb0</span><span style="color: #CF222E">:</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">discriminant</span><span style="color: #24292F">(_1) </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span><span style="color: #24292F">;</span><span style="color: #6E7781">            // scope 0</span></span>
<span class="line"><span style="color: #24292F">    _2 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #24292F">_1;</span><span style="color: #6E7781">                        // scope 1</span></span>
<span class="line"><span style="color: #24292F">    _4 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> _2;</span><span style="color: #6E7781">                         // scope 2</span></span>
<span class="line"><span style="color: #24292F">    _3 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">Option</span><span style="color: #CF222E">::</span><span style="color: #24292F">&lt;</span><span style="color: #953800">i32</span><span style="color: #24292F">&gt;</span><span style="color: #CF222E">::</span><span style="color: #8250DF">is_none</span><span style="color: #24292F">(</span><span style="color: #CF222E">move</span><span style="color: #24292F"> _4) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> bb1;</span><span style="color: #6E7781"> // scope 2</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">bb1</span><span style="color: #CF222E">:</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">switchInt</span><span style="color: #24292F">(</span><span style="color: #CF222E">move</span><span style="color: #24292F"> _3) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> [</span><span style="color: #0550AE">false</span><span style="color: #CF222E">:</span><span style="color: #24292F"> bb3, otherwise</span><span style="color: #CF222E">:</span><span style="color: #24292F"> bb2];</span><span style="color: #6E7781"> // scope 2</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">bb2</span><span style="color: #CF222E">:</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    _5 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F"> _1;</span><span style="color: #6E7781">                    // scope 2</span></span>
<span class="line"><span style="color: #24292F">    goto </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> bb3;</span><span style="color: #6E7781">                     // scope 2</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">bb3</span><span style="color: #CF222E">:</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">return</span><span style="color: #24292F">;</span><span style="color: #6E7781">                          // scope 0</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p><code>y(_2)</code> \u53EA\u5728\u57FA\u672C\u5757 <code>0</code> \u51FA\u73B0\u3002\u8DF3\u8F6C\u5230\u57FA\u672C\u5757 <code>2</code>\uFF0C<code>z(_5)</code> \u501F\u53EF\u53D8\u5F15\u7528\u7684\u65F6\u5019\u6CA1\u6709 <code>x</code> \u7684\u4E0D\u53EF\u53D8\u5F15\u7528\u4E86\uFF0C<code>borrowck</code> \u653E\u884C\u3002</p>
<p>\u5982\u679C\u66FF\u6362\u6210 <code>RefCell</code> \u5462\uFF1F</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #2e3440ff"><code><span class="line"><span style="color: #ECEFF4">#[</span><span style="color: #D8DEE9FF">allow</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">unused</span><span style="color: #ECEFF4">)]</span></span>
<span class="line"><span style="color: #81A1C1">fn</span><span style="color: #D8DEE9FF"> </span><span style="color: #88C0D0">main</span><span style="color: #ECEFF4">()</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">x</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> RefCell</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">Option</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">i32</span><span style="color: #ECEFF4">&gt;&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> RefCell</span><span style="color: #81A1C1">::</span><span style="color: #88C0D0">new</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">None</span><span style="color: #ECEFF4">);</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">y</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">x</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">borrow</span><span style="color: #ECEFF4">();</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">if</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">y</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">is_none</span><span style="color: #ECEFF4">()</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">z</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">x</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">borrow_mut</span><span style="color: #ECEFF4">();</span><span style="color: #616E88"> // &lt;- thread &#39;main&#39; panicked at &#39;already borrowed: BorrowMutError&#39;</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #ECEFF4">}</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">#[allow(unused)]</span></span>
<span class="line"><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">main</span><span style="color: #24292F">() {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">RefCell</span><span style="color: #24292F">&lt;</span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">i32</span><span style="color: #24292F">&gt;&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">RefCell</span><span style="color: #CF222E">::</span><span style="color: #8250DF">new</span><span style="color: #24292F">(</span><span style="color: #953800">None</span><span style="color: #24292F">);</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> y </span><span style="color: #CF222E">=</span><span style="color: #24292F"> x</span><span style="color: #CF222E">.</span><span style="color: #8250DF">borrow</span><span style="color: #24292F">();</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">if</span><span style="color: #24292F"> y</span><span style="color: #CF222E">.</span><span style="color: #8250DF">is_none</span><span style="color: #24292F">() {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">let</span><span style="color: #24292F"> z </span><span style="color: #CF222E">=</span><span style="color: #24292F"> x</span><span style="color: #CF222E">.</span><span style="color: #8250DF">borrow_mut</span><span style="color: #24292F">();</span><span style="color: #6E7781"> // &lt;- thread &#39;main&#39; panicked at &#39;already borrowed: BorrowMutError&#39;</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>panic \u4E86\u3002\u4E3A\u4EC0\u4E48\u5462\uFF1F</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #2e3440ff"><code><span class="line"><span style="color: #D8DEE9">scope</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">1</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">debug</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">x</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_1</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">                   // in scope 1</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_3</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> std</span><span style="color: #81A1C1">::</span><span style="color: #D8DEE9FF">cell</span><span style="color: #81A1C1">::</span><span style="color: #D8DEE9FF">Ref</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9">std</span><span style="color: #81A1C1">::</span><span style="color: #D8DEE9">option</span><span style="color: #81A1C1">::</span><span style="color: #D8DEE9FF">Option</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">i32</span><span style="color: #ECEFF4">&gt;&gt;;</span><span style="color: #616E88"> // in scope 1</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">scope</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">2</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #D8DEE9">debug</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">y</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_3</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">               // in scope 2</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_9</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> std</span><span style="color: #81A1C1">::</span><span style="color: #D8DEE9FF">cell</span><span style="color: #81A1C1">::</span><span style="color: #D8DEE9FF">RefMut</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9">std</span><span style="color: #81A1C1">::</span><span style="color: #D8DEE9">option</span><span style="color: #81A1C1">::</span><span style="color: #D8DEE9FF">Option</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">i32</span><span style="color: #ECEFF4">&gt;&gt;;</span><span style="color: #616E88"> // in scope 2</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #D8DEE9">scope</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">3</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">            </span><span style="color: #D8DEE9">debug</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">z</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_9</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">           // in scope 3</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #ECEFF4">}</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #ECEFF4">}</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9">bb0</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #88C0D0">discriminant</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9">_2</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">0</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">            // scope 0</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">_1</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> RefCell</span><span style="color: #81A1C1">::</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">Option</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">i32</span><span style="color: #ECEFF4">&gt;&gt;</span><span style="color: #81A1C1">::</span><span style="color: #88C0D0">new</span><span style="color: #ECEFF4">(</span><span style="color: #81A1C1">move</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_2</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">-&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb1</span><span style="color: #ECEFF4">;</span><span style="color: #616E88"> // scope 0</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9">bb1</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">_4</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">&amp;</span><span style="color: #D8DEE9">_1</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">                        // scope 1</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">_3</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> RefCell</span><span style="color: #81A1C1">::</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">Option</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">i32</span><span style="color: #ECEFF4">&gt;&gt;</span><span style="color: #81A1C1">::</span><span style="color: #88C0D0">borrow</span><span style="color: #ECEFF4">(</span><span style="color: #81A1C1">move</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_4</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">-&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb2</span><span style="color: #ECEFF4">;</span><span style="color: #616E88"> // scope 1</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9">bb2</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">_8</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">&amp;</span><span style="color: #D8DEE9">_3</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">                        // scope 2</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">_7</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">Ref</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">Option</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">i32</span><span style="color: #ECEFF4">&gt;&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">as</span><span style="color: #D8DEE9FF"> Deref</span><span style="color: #ECEFF4">&gt;</span><span style="color: #81A1C1">::</span><span style="color: #88C0D0">deref</span><span style="color: #ECEFF4">(</span><span style="color: #81A1C1">move</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_8</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">-&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">[</span><span style="color: #81A1C1">return:</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb3</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">unwind</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb9</span><span style="color: #ECEFF4">];</span><span style="color: #616E88"> // scope 2</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9">bb3</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">_6</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_7</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">                         // scope 2</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">_5</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> Option</span><span style="color: #81A1C1">::</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">i32</span><span style="color: #ECEFF4">&gt;</span><span style="color: #81A1C1">::</span><span style="color: #88C0D0">is_none</span><span style="color: #ECEFF4">(</span><span style="color: #81A1C1">move</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_6</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">-&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">[</span><span style="color: #81A1C1">return:</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb4</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">unwind</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb9</span><span style="color: #ECEFF4">];</span><span style="color: #616E88"> // scope 2</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9">bb4</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #88C0D0">switchInt</span><span style="color: #ECEFF4">(</span><span style="color: #81A1C1">move</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_5</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">-&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">[</span><span style="color: #81A1C1">false:</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb7</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">otherwise</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb5</span><span style="color: #ECEFF4">];</span><span style="color: #616E88"> // scope 2</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9">bb5</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">_10</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">&amp;</span><span style="color: #D8DEE9">_1</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">                       // scope 2</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #D8DEE9">_9</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> RefCell</span><span style="color: #81A1C1">::</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">Option</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">i32</span><span style="color: #ECEFF4">&gt;&gt;</span><span style="color: #81A1C1">::</span><span style="color: #88C0D0">borrow_mut</span><span style="color: #ECEFF4">(</span><span style="color: #81A1C1">move</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">_10</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">-&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">[</span><span style="color: #81A1C1">return:</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb6</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">unwind</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb9</span><span style="color: #ECEFF4">];</span><span style="color: #616E88"> // scope 2</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #616E88">/* z \u5728\u8FD9\u91CC\u6790\u6784 */</span></span>
<span class="line"><span style="color: #D8DEE9">bb6</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #88C0D0">drop</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9">_9</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">-&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">[</span><span style="color: #81A1C1">return:</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb7</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">unwind</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb9</span><span style="color: #ECEFF4">];</span><span style="color: #616E88"> // scope 2</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #616E88">/* y \u5728\u8FD9\u91CC\u624D\u6790\u6784 */</span></span>
<span class="line"><span style="color: #D8DEE9">bb7</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #88C0D0">drop</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9">_3</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">-&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">bb8</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">                 // scope 1</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9">bb8</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">return</span><span style="color: #ECEFF4">;</span><span style="color: #616E88">                          // scope 0</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #616E88">// ...</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">scope </span><span style="color: #0550AE">1</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    debug x </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> _1;</span><span style="color: #6E7781">                   // in scope 1</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> _3</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">std</span><span style="color: #CF222E">::</span><span style="color: #953800">cell</span><span style="color: #CF222E">::</span><span style="color: #953800">Ref</span><span style="color: #24292F">&lt;std</span><span style="color: #CF222E">::</span><span style="color: #24292F">option</span><span style="color: #CF222E">::</span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">i32</span><span style="color: #24292F">&gt;&gt;;</span><span style="color: #6E7781"> // in scope 1</span></span>
<span class="line"><span style="color: #24292F">    scope </span><span style="color: #0550AE">2</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">        debug y </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> _3;</span><span style="color: #6E7781">               // in scope 2</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">let</span><span style="color: #24292F"> _9</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">std</span><span style="color: #CF222E">::</span><span style="color: #953800">cell</span><span style="color: #CF222E">::</span><span style="color: #953800">RefMut</span><span style="color: #24292F">&lt;std</span><span style="color: #CF222E">::</span><span style="color: #24292F">option</span><span style="color: #CF222E">::</span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">i32</span><span style="color: #24292F">&gt;&gt;;</span><span style="color: #6E7781"> // in scope 2</span></span>
<span class="line"><span style="color: #24292F">        scope </span><span style="color: #0550AE">3</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">            debug z </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> _9;</span><span style="color: #6E7781">           // in scope 3</span></span>
<span class="line"><span style="color: #24292F">        }</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">bb0</span><span style="color: #CF222E">:</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">discriminant</span><span style="color: #24292F">(_2) </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span><span style="color: #24292F">;</span><span style="color: #6E7781">            // scope 0</span></span>
<span class="line"><span style="color: #24292F">    _1 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">RefCell</span><span style="color: #CF222E">::</span><span style="color: #24292F">&lt;</span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">i32</span><span style="color: #24292F">&gt;&gt;</span><span style="color: #CF222E">::</span><span style="color: #8250DF">new</span><span style="color: #24292F">(</span><span style="color: #CF222E">move</span><span style="color: #24292F"> _2) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> bb1;</span><span style="color: #6E7781"> // scope 0</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">bb1</span><span style="color: #CF222E">:</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    _4 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #24292F">_1;</span><span style="color: #6E7781">                        // scope 1</span></span>
<span class="line"><span style="color: #24292F">    _3 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">RefCell</span><span style="color: #CF222E">::</span><span style="color: #24292F">&lt;</span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">i32</span><span style="color: #24292F">&gt;&gt;</span><span style="color: #CF222E">::</span><span style="color: #8250DF">borrow</span><span style="color: #24292F">(</span><span style="color: #CF222E">move</span><span style="color: #24292F"> _4) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> bb2;</span><span style="color: #6E7781"> // scope 1</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">bb2</span><span style="color: #CF222E">:</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    _8 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #24292F">_3;</span><span style="color: #6E7781">                        // scope 2</span></span>
<span class="line"><span style="color: #24292F">    _7 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> &lt;</span><span style="color: #953800">Ref</span><span style="color: #24292F">&lt;</span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">i32</span><span style="color: #24292F">&gt;&gt; </span><span style="color: #CF222E">as</span><span style="color: #24292F"> </span><span style="color: #953800">Deref</span><span style="color: #24292F">&gt;</span><span style="color: #CF222E">::</span><span style="color: #8250DF">deref</span><span style="color: #24292F">(</span><span style="color: #CF222E">move</span><span style="color: #24292F"> _8) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> [</span><span style="color: #CF222E">return:</span><span style="color: #24292F"> bb3, unwind</span><span style="color: #CF222E">:</span><span style="color: #24292F"> bb9];</span><span style="color: #6E7781"> // scope 2</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">bb3</span><span style="color: #CF222E">:</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    _6 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> _7;</span><span style="color: #6E7781">                         // scope 2</span></span>
<span class="line"><span style="color: #24292F">    _5 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">Option</span><span style="color: #CF222E">::</span><span style="color: #24292F">&lt;</span><span style="color: #953800">i32</span><span style="color: #24292F">&gt;</span><span style="color: #CF222E">::</span><span style="color: #8250DF">is_none</span><span style="color: #24292F">(</span><span style="color: #CF222E">move</span><span style="color: #24292F"> _6) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> [</span><span style="color: #CF222E">return:</span><span style="color: #24292F"> bb4, unwind</span><span style="color: #CF222E">:</span><span style="color: #24292F"> bb9];</span><span style="color: #6E7781"> // scope 2</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">bb4</span><span style="color: #CF222E">:</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">switchInt</span><span style="color: #24292F">(</span><span style="color: #CF222E">move</span><span style="color: #24292F"> _5) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> [</span><span style="color: #0550AE">false</span><span style="color: #CF222E">:</span><span style="color: #24292F"> bb7, otherwise</span><span style="color: #CF222E">:</span><span style="color: #24292F"> bb5];</span><span style="color: #6E7781"> // scope 2</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">bb5</span><span style="color: #CF222E">:</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    _10 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #24292F">_1;</span><span style="color: #6E7781">                       // scope 2</span></span>
<span class="line"><span style="color: #24292F">    _9 </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">RefCell</span><span style="color: #CF222E">::</span><span style="color: #24292F">&lt;</span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">i32</span><span style="color: #24292F">&gt;&gt;</span><span style="color: #CF222E">::</span><span style="color: #8250DF">borrow_mut</span><span style="color: #24292F">(</span><span style="color: #CF222E">move</span><span style="color: #24292F"> _10) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> [</span><span style="color: #CF222E">return:</span><span style="color: #24292F"> bb6, unwind</span><span style="color: #CF222E">:</span><span style="color: #24292F"> bb9];</span><span style="color: #6E7781"> // scope 2</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6E7781">/* z \u5728\u8FD9\u91CC\u6790\u6784 */</span></span>
<span class="line"><span style="color: #24292F">bb6</span><span style="color: #CF222E">:</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">drop</span><span style="color: #24292F">(_9) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> [</span><span style="color: #CF222E">return:</span><span style="color: #24292F"> bb7, unwind</span><span style="color: #CF222E">:</span><span style="color: #24292F"> bb9];</span><span style="color: #6E7781"> // scope 2</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6E7781">/* y \u5728\u8FD9\u91CC\u624D\u6790\u6784 */</span></span>
<span class="line"><span style="color: #24292F">bb7</span><span style="color: #CF222E">:</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">drop</span><span style="color: #24292F">(_3) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> bb8;</span><span style="color: #6E7781">                 // scope 1</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">bb8</span><span style="color: #CF222E">:</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">return</span><span style="color: #24292F">;</span><span style="color: #6E7781">                          // scope 0</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6E7781">// ...</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>\u4F5C\u7528\u57DF\u662F\u4E00\u6837\u7684\u554A\uFF1F\u4F46\u662F\u6CE8\u610F\uFF0C<code>y(_3)</code> \u4ECE <code>RefCell</code> \u501F\u51FA\u7684 <code>Ref</code> \u662F\u667A\u80FD\u6307\u9488\uFF0C\u9700\u8981\u6790\u6784\u8FD9\u4E00\u6B65\uFF0C\u5B83\u4E00\u76F4\u4FDD\u6301\u5230 <code>if</code> \u4F5C\u7528\u57DF\u7684\u5C3E\u90E8\uFF0C\u4E5F\u5C31\u662F\u57FA\u672C\u5757 <code>7</code> \u624D\u6790\u6784\uFF01\u5728\u6B64\u4E4B\u524D\u57FA\u672C\u5757 <code>5</code> \u8981\u6C42\u501F\u51FA <code>RefMut</code>\uFF0C\u4E8E\u662F\u5F53\u573A panic\u{1F631}\u3002</p>
<p>\u600E\u4E48\u89E3\u51B3\u5462\uFF1F\u624B\u52A8 <code>drop()</code>\u{1F92A}\uFF01\u4E8B\u5B9E\u4E0A\uFF0C<a href="https://doc.rust-lang.org/std/mem/fn.drop.html#examples" target="_blank" rel="noopener"><code>mem::drop</code> \u7684\u6587\u6863\u5DF2\u7ECF\u7ED9\u51FA\u4E86\u7C7B\u4F3C\u7684\u4F8B\u5B50</a>\u3002</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #2e3440ff"><code><span class="line"><span style="color: #ECEFF4">#[</span><span style="color: #D8DEE9FF">allow</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">unused</span><span style="color: #ECEFF4">)]</span></span>
<span class="line"><span style="color: #81A1C1">fn</span><span style="color: #D8DEE9FF"> </span><span style="color: #88C0D0">main</span><span style="color: #ECEFF4">()</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">x</span><span style="color: #81A1C1">:</span><span style="color: #D8DEE9FF"> RefCell</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">Option</span><span style="color: #ECEFF4">&lt;</span><span style="color: #D8DEE9FF">i32</span><span style="color: #ECEFF4">&gt;&gt;</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> RefCell</span><span style="color: #81A1C1">::</span><span style="color: #88C0D0">new</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">None</span><span style="color: #ECEFF4">);</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">y</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">x</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">borrow</span><span style="color: #ECEFF4">();</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">if</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">b</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">y</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">is_none</span><span style="color: #ECEFF4">();</span><span style="color: #D8DEE9FF"> </span><span style="color: #88C0D0">drop</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9">y</span><span style="color: #ECEFF4">);</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">b</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">}</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #81A1C1">let</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">z</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">x</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">borrow_mut</span><span style="color: #ECEFF4">();</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #ECEFF4">}</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">#[allow(unused)]</span></span>
<span class="line"><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">main</span><span style="color: #24292F">() {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">RefCell</span><span style="color: #24292F">&lt;</span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">i32</span><span style="color: #24292F">&gt;&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">RefCell</span><span style="color: #CF222E">::</span><span style="color: #8250DF">new</span><span style="color: #24292F">(</span><span style="color: #953800">None</span><span style="color: #24292F">);</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> y </span><span style="color: #CF222E">=</span><span style="color: #24292F"> x</span><span style="color: #CF222E">.</span><span style="color: #8250DF">borrow</span><span style="color: #24292F">();</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">if</span><span style="color: #24292F"> { </span><span style="color: #CF222E">let</span><span style="color: #24292F"> b </span><span style="color: #CF222E">=</span><span style="color: #24292F"> y</span><span style="color: #CF222E">.</span><span style="color: #8250DF">is_none</span><span style="color: #24292F">(); </span><span style="color: #8250DF">drop</span><span style="color: #24292F">(y); b } {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">let</span><span style="color: #24292F"> z </span><span style="color: #CF222E">=</span><span style="color: #24292F"> x</span><span style="color: #CF222E">.</span><span style="color: #8250DF">borrow_mut</span><span style="color: #24292F">();</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
</div>`})}}};export{C as category,D as date,d as default,i as tags,F as title};
