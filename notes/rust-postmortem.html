<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="apple-touch-icon" href="/pwa-192x192.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#00aba9"><meta name="msapplication-TileColor" content="#00aba9"><meta name="theme-color" content="#ffffff"><script type="module" async="" crossorigin="" src="/assets/app.e5322945.js"></script><style>button[data-v-6ed7d32f]{padding:.25rem;font-size:1.125rem;line-height:1.75rem;color:rgba(var(--color-accent))}#app{display:grid;grid-template-rows:auto 1fr auto;grid-template-columns:100%;margin-left:1rem;margin-right:1rem;height:100%}@media (min-width:1024px){#app{margin-left:0;margin-right:0}}*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:currentColor}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}strong{font-weight:bolder}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:1em}button{font-family:inherit;font-size:100%;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}button{-webkit-appearance:button;background-color:transparent;background-image:none}h1,h2,hr,p,pre{margin:0}ul{list-style:none;margin:0;padding:0}button{cursor:pointer}*,::after,::before{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-scroll-snap-strictness:proximity;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgba(0,0,0,0);--un-ring-shadow:0 0 rgba(0,0,0,0);--un-shadow:0 0 rgba(0,0,0,0);--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgba(147,197,253,0.5)}[i-mdi-file=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg preserveAspectRatio='xMidYMid meet' viewBox='0 0 24 24' display='inline-block' vertical-align='sub' width='1.25em' height='1.25em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M13 9V3.5L18.5 9M6 2c-1.11 0-2 .89-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6H6Z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;vertical-align:sub;width:1.25em;height:1.25em}.i-mdi-folder,[i-mdi-folder=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg preserveAspectRatio='xMidYMid meet' viewBox='0 0 24 24' display='inline-block' vertical-align='sub' width='1.25em' height='1.25em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M10 4H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-8l-2-2Z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;vertical-align:sub;width:1.25em;height:1.25em}[i-mdi-table-large=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg preserveAspectRatio='xMidYMid meet' viewBox='0 0 24 24' display='inline-block' vertical-align='sub' width='1.25em' height='1.25em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M4 3h16a2 2 0 0 1 2 2v15a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2m0 4v3h4V7H4m6 0v3h4V7h-4m10 3V7h-4v3h4M4 12v3h4v-3H4m0 8h4v-3H4v3m6-8v3h4v-3h-4m0 8h4v-3h-4v3m10 0v-3h-4v3h4m0-8h-4v3h4v-3Z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;vertical-align:sub;width:1.25em;height:1.25em}[i-mdi-text-box=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg preserveAspectRatio='xMidYMid meet' viewBox='0 0 24 24' display='inline-block' vertical-align='sub' width='1.25em' height='1.25em' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M14 17H7v-2h7m3-2H7v-2h10m0-2H7V7h10m2-4H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;vertical-align:sub;width:1.25em;height:1.25em}[btn-icon=""]:hover{color:rgba(var(--color-accent));transition-duration:.3s;transition-timing-function:cubic-bezier(0,0,.2,1)}.transition-lively,[btn-icon=""],[transition-lively=""]{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:150ms;transition-duration:.2s;transition-timing-function:cubic-bezier(.4,0,1,1)}.transition-lively:hover,[transition-lively=""]:hover{transition-duration:.3s;transition-timing-function:cubic-bezier(0,0,.2,1)}.relative{position:relative}.my-4{margin-top:1rem;margin-bottom:1rem}.mb-8,[m~=b-8]{margin-bottom:2rem}.mt-4{margin-top:1rem}.inline-block{display:inline-block}.flex{display:flex}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-start{justify-content:flex-start}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-0\.5{grid-gap:.125rem;gap:.125rem}.gap-1{grid-gap:.25rem;gap:.25rem}.gap-2{grid-gap:.5rem;gap:.5rem}.gap-3{grid-gap:.75rem;gap:.75rem}.gap-x-1{grid-column-gap:.25rem;column-gap:.25rem}.gap-y-0\.5{grid-row-gap:.125rem;row-gap:.125rem}.rounded{border-radius:.25rem}.hover\:bg-acc:hover,[bg~=acc]{background-color:rgba(var(--color-accent))}.hover\:bg-sec:hover,[bg~="hover\:sec"]:hover{background-color:rgba(var(--color-secondary))}.p-1{padding:.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.text-left{text-align:left}.font-mono,[font~=mono]{font-family:var(--font-mono)}.text-xs{font-size:.75rem;line-height:1rem}.font-bold,[font~=bold]{font-weight:700}[color~="\#00aba9"]{--un-text-opacity:1;color:rgba(0,171,169,var(--un-text-opacity))}.text-acc{color:rgba(var(--color-accent))}.hover\:text-bgd:hover,[text~=bgd]{color:rgba(var(--color-background))}.hover\:text-sec:hover,.text-sec{color:rgba(var(--color-secondary))}@media (min-width:1024px){.lg\:sticky{position:sticky}.lg\:top-4{top:1rem}}:root{--shiki-color-text:#EEEEEE;--shiki-color-background:#333333;--shiki-token-constant:#660000;--shiki-token-string:#770000;--shiki-token-comment:#880000;--shiki-token-keyword:#990000;--shiki-token-parameter:#AA0000;--shiki-token-function:#BB0000;--shiki-token-string-expression:#CC0000;--shiki-token-punctuation:#DD0000;--shiki-token-link:#EE0000}:root{--font-sans:"Noto Sans",var(--custom-font-sans, sans-serif),"SF Pro",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Avenir Next","Helvetica Neue",sans-serif;--font-serif:"Noto Serif",var(--custom-font-serif, serif),"Noto Serif","New York","Roboto Slab",Cambria,Georgia,Times,"Times New Roman",serif;--font-mono:"JetBrains Mono","SF Mono","Roboto Mono",Menlo,"Cascadia Code",Consolas,monospace}html:not(.dark){--color-accent-default:33,119,184;--color-accent:var(--accent-light-accent, var(--color-accent-default));--color-secondary-default:0,58,112;--color-secondary:var(--accent-light-secondary, var(--color-secondary-default));--color-background:245,245,245;--color-foreground:29,37,45;--color-dim:115,125,124}html{height:100%;width:100%;margin:0;padding:0;text-align:center;font-size:1rem;line-height:1.5rem;overflow-x:hidden;overflow-y:auto;overflow-y:overlay;background-color:rgba(var(--color-background));color:rgba(var(--color-foreground));font-family:var(--font-sans)}body{height:100%;margin:auto;padding:0;max-width:75ch}code,pre{font-family:var(--font-mono)}h1{font-size:1.875rem;line-height:2.25rem;font-weight:700}button{outline:2px solid transparent!important;outline-offset:2px!important}#md a{color:rgba(var(--color-accent));background-color:rgba(var(--color-accent),.125);border-radius:.25rem;padding:.125rem .5ch;transition:all .2s ease-in}#md a:hover{color:rgba(var(--color-secondary));background-color:rgba(var(--color-secondary),.25);transition:all .3s ease-out}#md em{padding-right:.25ch}#md h2{margin:1.25em 0 .75em;font-family:var(--font-serif);font-weight:700}#md article[note]{margin:1.25em 0}#md h2{font-size:1.5em}#md p{margin:1em 0}#md h2:first-child,#md p:first-child,#md pre:first-child{margin-top:0}#md h2:last-child,#md p:last-child,#md pre:last-child{margin-bottom:0}#md hr{border:0;height:0;border-bottom:1px solid rgba(var(--color-foreground))}#md hr.talk-separator{height:1.5em;border:none;overflow:visible;text-align:center}#md hr.talk-separator:after{position:relative;content:"***";letter-spacing:.5em;background:0 0}#md ul{margin:1em 0;padding-left:1em}#md ul{list-style:disc}#md li{line-height:150%;margin:.25em 0}#md pre{border-radius:.25rem;padding:1em;max-width:100%;overflow:auto}#md p code{font-size:.95rem}#md code,#md pre{font-family:var(--font-mono);line-height:154%}#md code:not(pre*,a*){background-color:rgba(var(--color-dim),.25);border-radius:.25rem;padding:.125rem .5ch}#md pre{margin:1em 0}@media (min-width:1024px){#toc{position:absolute;left:100%;padding:0 .5em;width:calc((100vw - 100%)/ 2 - 2em);margin-left:1em;max-height:50vh;overflow-y:auto}}</style><link rel="preload" href="/assets/app.7456a1e8.css" as="style"><link rel="modulepreload" crossorigin="" href="/assets/rust-postmortem.6aae2440.js"><link rel="modulepreload" crossorigin="" href="/assets/TheArticle.bc4d939f.js"><link rel="preload" href="/assets/TheArticle.080d4a8a.css" as="style"><title>In Rust We Bust | Pak</title><meta name="description" content="Rust 语言的踩坑记录。"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css" integrity="sha384-zTROYFVGOfTw7JV7KUu8udsvW2fx4lWOsCEDqhBreBwlHI4ioVRtmIvEThzJHGET" crossorigin="anonymous"><meta name="head:count" content="2"></head><body><div id="app" data-server-rendered="true"><!--[--><header class="flex justify-between items-center my-4 gap-2" data-v-6ed7d32f=""><nav class="inline-block px-2 py-1 rounded transition-lively" text="bgd" bg="acc hover:sec" font="mono bold" data-v-6ed7d32f=""><a href="/" class="" data-v-6ed7d32f="">pαk</a></nav><nav class="flex justify-between items-center gap-3" data-v-6ed7d32f=""><button title="Archive" transition-lively="" class="hover:text-sec" data-v-6ed7d32f=""><a href="/archive" class="" title="Archive" data-v-6ed7d32f=""><div i-mdi-text-box="" data-v-6ed7d32f=""></div></a></button><button title="Posts" transition-lively="" class="hover:text-sec" data-v-6ed7d32f=""><a href="/posts" class="" title="Posts" data-v-6ed7d32f=""><div i-mdi-file="" data-v-6ed7d32f=""></div></a></button><button title="Sheets" transition-lively="" class="hover:text-sec" data-v-6ed7d32f=""><a href="/sheets" class="" title="Sheets" data-v-6ed7d32f=""><div i-mdi-table-large="" data-v-6ed7d32f=""></div></a></button><button title="Notes" transition-lively="" class="hover:text-sec" data-v-6ed7d32f=""><a href="/notes" class="" title="Notes" data-v-6ed7d32f=""><div i-mdi-folder="" data-v-6ed7d32f=""></div></a></button></nav></header><main class="text-left"><main class="mb-8"><article class="text-left relative"><header class="flex flex-col justify-start items-start gap-2 mt-4 mb-8"><h1>In Rust We Bust</h1><div class="flex flex-wrap gap-x-1 gap-y-0.5 justify-start items-center"><span class="flex justify-center"><div btn-icon=""><a href="/notes" class="" title="All notes"><div class="i-mdi-folder"></div></a></div></span><span class="flex gap-0.5 justify-center items-center"><span class="inline-block text-xs rounded p-1 font-mono font-bold transition-lively"><!--[--><time>2022/07/06</time><!--]--></span></span><!--[--><span class="flex gap-0.5 justify-center items-center"><span class="inline-block text-xs rounded p-1 font-mono font-bold transition-lively text-acc hover:bg-acc hover:text-bgd"><!--[--><a href="/categories/comp" class="">comp</a><!--]--></span></span><span class="flex gap-0.5 justify-center items-center"><!--[--><span class="inline-block text-xs rounded p-1 font-mono font-bold transition-lively text-sec hover:bg-sec hover:text-bgd"><!--[--><a href="/tags?tag=rust" class=""> @rust</a><!--]--></span><span class="inline-block text-xs rounded p-1 font-mono font-bold transition-lively text-sec hover:bg-sec hover:text-bgd"><!--[--><a href="/tags?tag=pl" class=""> @pl</a><!--]--></span><!--]--></span><!----><span class="flex gap-0.5 justify-center items-center"><!--[--><!--]--></span><!--]--></div></header><div class="lg:sticky lg:top-4"><nav id="toc"><ul class="flex flex-col gap-1"><!--[--><!--]--></ul></nav></div><div m="b-8"></div><article id="md" lang="zh-Hans"><div><p>Rust 语言的踩坑记录。</p><!-- more --><p><s>对 <code>rustc</code> 施用 <a href="https://harrypotter.fandom.com/wiki/Silencing_Charm" target="_blank" rel="noopener"><code>Silencio</code></a> 可不能解决问题</s>。</p><article note=""><h2 id="refcell-和作用域" tabindex="-1"><code>RefCell</code> 和作用域</h2><p>Rust 通过 <code>std::cell</code> 提供的“内部可变性”看起来很爽——可以把一个不可变的数据的一部分搞成可变的。其中的 <code>RefCell</code> 可以把<s>美名远扬</s>的编译期 <code>borrowck</code> 搞到运行期去，实现往不可变数据内部指一个可写的指针 <code>RefMut</code> 的功能🤗。</p><p>那么能不能把原数据用 <code>RefCell</code> 一包，然后直接把 <code>&amp;x, &amp;mut x</code> 替换成 <code>x.borrow(), x.borrow_mut()</code> ？编译器会答应，但作用域问题可能会导致运行时 panic🙃。</p><p>考虑下面一段代码：</p><pre class="shiki" style="background-color:#282c34"><code><span class="line"><span style="color:#abb2bf">#[allow(unused)]</span></span>
<span class="line"><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">main</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">mut</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt; </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">None</span><span style="color:#abb2bf">;</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#e06c75">x</span><span style="color:#abb2bf">;</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">if</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf">.</span><span style="color:#61afef">is_none</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">z</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#c678dd">mut</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">;</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><p>问题全然无，编译通过。<code>y</code> 是不可变引用，但是在 <code>if</code> 的表达式里只用过一次就没再用过，因此 <code>z</code> 可以高高兴兴地借出可变引用。看看 MIR：</p><pre class="shiki" style="background-color:#282c34"><code><span class="line"><span style="color:#abb2bf">$ rustc src/main.rs --emit mir</span></span>
<span class="line"></span></code></pre><pre class="shiki" style="background-color:#282c34"><code><span class="line"><span style="color:#e06c75">scope</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">1</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">debug</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf"> =&gt; </span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                   // in scope 1</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_2</span><span style="color:#abb2bf">: &amp;</span><span style="color:#e5c07b">std</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">option</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;;</span><span style="color:#7f848e;font-style:italic"> // in scope 1</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">scope</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">2</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e06c75">debug</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf"> =&gt; </span><span style="color:#e06c75">_2</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">               // in scope 2</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_5</span><span style="color:#abb2bf">: &amp;</span><span style="color:#c678dd">mut</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">std</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">option</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;;</span><span style="color:#7f848e;font-style:italic"> // in scope 2</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e06c75">scope</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">3</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">            </span><span style="color:#e06c75">debug</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">z</span><span style="color:#abb2bf"> =&gt; </span><span style="color:#e06c75">_5</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">           // in scope 3</span></span>
<span class="line"><span style="color:#abb2bf">        }</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb0</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">discriminant</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">) </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">0</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">            // scope 0</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_2</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                        // scope 1</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_4</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_2</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                         // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_3</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">::&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;::</span><span style="color:#61afef">is_none</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_4</span><span style="color:#abb2bf">) -&gt; </span><span style="color:#e06c75">bb1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb1</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">switchInt</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_3</span><span style="color:#abb2bf">) -&gt; [</span><span style="color:#d19a66">false</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb3</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">otherwise</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb2</span><span style="color:#abb2bf">];</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb2</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_5</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#c678dd">mut</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                    // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">goto</span><span style="color:#abb2bf"> -&gt; </span><span style="color:#e06c75">bb3</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                     // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb3</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">return</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                          // scope 0</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><p><code>y(_2)</code> 只在基本块 <code>0</code> 出现。跳转到基本块 <code>2</code>，<code>z(_5)</code> 借可变引用的时候没有 <code>x</code> 的不可变引用了，<code>borrowck</code> 放行。</p><p>如果替换成 <code>RefCell</code> 呢？</p><pre class="shiki" style="background-color:#282c34"><code><span class="line"><span style="color:#abb2bf">#[allow(unused)]</span></span>
<span class="line"><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">main</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt; </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#e5c07b">None</span><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow</span><span style="color:#abb2bf">();</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">if</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf">.</span><span style="color:#61afef">is_none</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">z</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">();</span><span style="color:#7f848e;font-style:italic"> // &lt;- thread 'main' panicked at 'already borrowed: BorrowMutError'</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><p>panic 了。为什么呢？</p><pre class="shiki" style="background-color:#282c34"><code><span class="line"><span style="color:#e06c75">scope</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">1</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">debug</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf"> =&gt; </span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                   // in scope 1</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_3</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">std</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">cell</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">Ref</span><span style="color:#abb2bf">&lt;</span><span style="color:#e06c75">std</span><span style="color:#abb2bf">::</span><span style="color:#e06c75">option</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt;;</span><span style="color:#7f848e;font-style:italic"> // in scope 1</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">scope</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">2</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e06c75">debug</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf"> =&gt; </span><span style="color:#e06c75">_3</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">               // in scope 2</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_9</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">std</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">cell</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">RefMut</span><span style="color:#abb2bf">&lt;</span><span style="color:#e06c75">std</span><span style="color:#abb2bf">::</span><span style="color:#e06c75">option</span><span style="color:#abb2bf">::</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt;;</span><span style="color:#7f848e;font-style:italic"> // in scope 2</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e06c75">scope</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">3</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">            </span><span style="color:#e06c75">debug</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">z</span><span style="color:#abb2bf"> =&gt; </span><span style="color:#e06c75">_9</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">           // in scope 3</span></span>
<span class="line"><span style="color:#abb2bf">        }</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb0</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">discriminant</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">_2</span><span style="color:#abb2bf">) </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">0</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">            // scope 0</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_1</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt;::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_2</span><span style="color:#abb2bf">) -&gt; </span><span style="color:#e06c75">bb1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic"> // scope 0</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb1</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_4</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                        // scope 1</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_3</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt;::</span><span style="color:#61afef">borrow</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_4</span><span style="color:#abb2bf">) -&gt; </span><span style="color:#e06c75">bb2</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic"> // scope 1</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb2</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_8</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#e06c75">_3</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                        // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_7</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &lt;</span><span style="color:#e5c07b">Ref</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt; </span><span style="color:#c678dd">as</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Deref</span><span style="color:#abb2bf">&gt;::</span><span style="color:#61afef">deref</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_8</span><span style="color:#abb2bf">) -&gt; [</span><span style="color:#c678dd">return</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb3</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">unwind</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb9</span><span style="color:#abb2bf">];</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb3</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_6</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_7</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                         // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_5</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">::&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;::</span><span style="color:#61afef">is_none</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_6</span><span style="color:#abb2bf">) -&gt; [</span><span style="color:#c678dd">return</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb4</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">unwind</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb9</span><span style="color:#abb2bf">];</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb4</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">switchInt</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_5</span><span style="color:#abb2bf">) -&gt; [</span><span style="color:#d19a66">false</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb7</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">otherwise</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb5</span><span style="color:#abb2bf">];</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb5</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_10</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> &amp;</span><span style="color:#e06c75">_1</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                       // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">_9</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt;::</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">move</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">_10</span><span style="color:#abb2bf">) -&gt; [</span><span style="color:#c678dd">return</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb6</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">unwind</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb9</span><span style="color:#abb2bf">];</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7f848e;font-style:italic">/* z 在这里析构 */</span></span>
<span class="line"><span style="color:#e06c75">bb6</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">drop</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">_9</span><span style="color:#abb2bf">) -&gt; [</span><span style="color:#c678dd">return</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb7</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">unwind</span><span style="color:#abb2bf">: </span><span style="color:#e06c75">bb9</span><span style="color:#abb2bf">];</span><span style="color:#7f848e;font-style:italic"> // scope 2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7f848e;font-style:italic">/* y 在这里才析构 */</span></span>
<span class="line"><span style="color:#e06c75">bb7</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">drop</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">_3</span><span style="color:#abb2bf">) -&gt; </span><span style="color:#e06c75">bb8</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                 // scope 1</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#e06c75">bb8</span><span style="color:#abb2bf">: {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">return</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic">                          // scope 0</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7f848e;font-style:italic">// ...</span></span>
<span class="line"></span></code></pre><p>作用域是一样的啊？但是注意，<code>y(_3)</code> 从 <code>RefCell</code> 借出的 <code>Ref</code> 是智能指针，需要析构这一步，它一直保持到 <code>if</code> 作用域的尾部，也就是基本块 <code>7</code> 才析构！在此之前基本块 <code>5</code> 要求借出 <code>RefMut</code>，于是当场 panic😱。</p><p>怎么解决呢？手动 <code>drop()</code>🤪！事实上，<code>mem::drop</code> 的文档已经给出了类似的<a href="https://doc.rust-lang.org/std/mem/fn.drop.html#examples" target="_blank" rel="noopener">例子</a>。</p><pre class="shiki" style="background-color:#282c34"><code><span class="line"><span style="color:#abb2bf">#[allow(unused)]</span></span>
<span class="line"><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">main</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt; </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#e5c07b">None</span><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow</span><span style="color:#abb2bf">();</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">if</span><span style="color:#abb2bf"> { </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">b</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">y</span><span style="color:#abb2bf">.</span><span style="color:#61afef">is_none</span><span style="color:#abb2bf">(); </span><span style="color:#61afef">drop</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">y</span><span style="color:#abb2bf">); </span><span style="color:#e06c75">b</span><span style="color:#abb2bf"> } {</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">z</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">();</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><p><strong>更新</strong>：把引用保存在临时变量里其实不太 Rust 风味，特别是保存 <code>RefCell</code> 或者 <code>Mutex</code> 的守卫（guard）。所以，不提取临时中间变量反而是更符合 Rust 的：</p><pre class="shiki" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">Option</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">i32</span><span style="color:#abb2bf">&gt;&gt; </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#e5c07b">None</span><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#c678dd">if</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow</span><span style="color:#abb2bf">().</span><span style="color:#61afef">is_none</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">z</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">x</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">();</span><span style="color:#7f848e;font-style:italic"> // Fine!</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre></article><hr class="talk-separator"><article note=""><h2 id="初始化器也是表达式" tabindex="-1">初始化器也是表达式</h2><p><s>这不是显然的吗</s>？</p><p>元组（tuple）和数组（array）都是 Rust 的基本类型（primitive type）。元组的初始化器用 <code>()</code>，数组用 <code>[]</code>，分隔符是 <code>,</code>。虽然初始化器<em>显然</em>是表达式，但有时候逗号一加，就难免想这样写：</p><pre class="shiki" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">cell</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#61afef">vec!</span><span style="color:#abb2bf">[</span><span style="color:#d19a66">1</span><span style="color:#abb2bf">, </span><span style="color:#d19a66">2</span><span style="color:#abb2bf">, </span><span style="color:#d19a66">3</span><span style="color:#abb2bf">]);</span></span>
<span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">values</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> (</span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#e06c75">cell</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">().</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">().</span><span style="color:#61afef">max</span><span style="color:#abb2bf">().</span><span style="color:#61afef">cloned</span><span style="color:#abb2bf">(),</span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#e06c75">cell</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">().</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">().</span><span style="color:#61afef">min</span><span style="color:#abb2bf">().</span><span style="color:#61afef">cloned</span><span style="color:#abb2bf">(), </span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#7f848e;font-style:italic">/*   ^^^^^^^^^^ </span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">       thread 'main' panicked at 'already borrowed: BorrowMutError'</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  */</span></span>
<span class="line"><span style="color:#abb2bf">);</span></span>
<span class="line"></span></code></pre><p>于是就吃了一个 panic。尽管用逗号隔开了，但<strong>表达式里面的临时变量仍然会生存到表达式的结束</strong>，函数调用的实参同理。考虑下面一个简单的例子就知道为什么要这样了：</p><pre class="shiki" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">mut</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">i</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#d19a66">42</span><span style="color:#abb2bf">;</span></span>
<span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">tuple</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> (&amp;</span><span style="color:#e06c75">i</span><span style="color:#abb2bf">, &amp;</span><span style="color:#c678dd">mut</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">i</span><span style="color:#abb2bf">);</span><span style="color:#7f848e;font-style:italic"> // 显然不行吧</span></span>
<span class="line"></span></code></pre><p><s>大家最喜欢的</s> C++ 也是一样的：</p><pre class="shiki" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">#include</span><span style="color:#abb2bf"> </span><span style="color:#98c379">&lt;iostream&gt;</span></span>
<span class="line"><span style="color:#c678dd">#include</span><span style="color:#abb2bf"> </span><span style="color:#98c379">&lt;tuple&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">struct</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">A</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">int</span><span style="color:#abb2bf"> v;</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">A</span><span style="color:#abb2bf">(</span><span style="color:#c678dd">int</span><span style="color:#abb2bf"> </span><span style="color:#e06c75;font-style:italic">i</span><span style="color:#abb2bf">): </span><span style="color:#61afef">v</span><span style="color:#abb2bf">(i) {</span></span>
<span class="line"><span style="color:#abb2bf">        std::cout </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> </span><span style="color:#98c379">"A("</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> i </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> </span><span style="color:#98c379">")"</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> std::endl;</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#61afef">~A</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">        std::cout </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> </span><span style="color:#98c379">"~A("</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> v </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> </span><span style="color:#98c379">")"</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> std::endl;</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">int</span><span style="color:#abb2bf"> </span><span style="color:#61afef">main</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">    std::tuple</span><span style="color:#c678dd">&lt;</span><span style="color:#abb2bf">A, A</span><span style="color:#c678dd">&gt;</span><span style="color:#abb2bf"> t </span><span style="color:#c678dd">=</span><span style="color:#abb2bf"> {</span><span style="color:#61afef">A</span><span style="color:#abb2bf">(</span><span style="color:#d19a66">1</span><span style="color:#abb2bf">), </span><span style="color:#61afef">A</span><span style="color:#abb2bf">(</span><span style="color:#d19a66">2</span><span style="color:#abb2bf">)};</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  	/*</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  	                      A(1)</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  	                            A(2)</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  	                           ~A(2)</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  	                     ~A(1)</span></span>
<span class="line"><span style="color:#7f848e;font-style:italic">  	*/</span></span>
<span class="line"><span style="color:#abb2bf">    std::cout </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> </span><span style="color:#98c379">"---"</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">&lt;&lt;</span><span style="color:#abb2bf"> std::endl;</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><p>所以只好乖乖地加一个中间变量：</p><pre class="shiki" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">r</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">cell</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">();</span></span>
<span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">values</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> (</span><span style="color:#e06c75">r</span><span style="color:#abb2bf">.</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">().</span><span style="color:#61afef">max</span><span style="color:#abb2bf">().</span><span style="color:#61afef">cloned</span><span style="color:#abb2bf">(), </span><span style="color:#e06c75">r</span><span style="color:#abb2bf">.</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">().</span><span style="color:#61afef">min</span><span style="color:#abb2bf">().</span><span style="color:#61afef">cloned</span><span style="color:#abb2bf">());</span></span>
<span class="line"></span></code></pre><p>或者，<s>写一个宏</s>（<code>rust-analyzer</code>：礼貌你吗🤬？）：</p><pre class="shiki" style="background-color:#282c34"><code><span class="line"><span style="color:#61afef">macro_rules!</span><span style="color:#abb2bf"> </span><span style="color:#61afef">with</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">    ($</span><span style="color:#e06c75">i</span><span style="color:#abb2bf">:</span><span style="color:#e06c75">ident</span></span>
<span class="line"><span style="color:#abb2bf">      .$($</span><span style="color:#e06c75">h</span><span style="color:#abb2bf">:</span><span style="color:#e06c75">ident</span><span style="color:#abb2bf"> ( $($</span><span style="color:#e06c75">e0</span><span style="color:#abb2bf">:</span><span style="color:#e06c75">expr</span><span style="color:#abb2bf">),*) ).*</span><span style="color:#7f848e;font-style:italic"> // 要丢弃的可变引用</span></span>
<span class="line"><span style="color:#abb2bf">      #</span></span>
<span class="line"><span style="color:#abb2bf">      .$($</span><span style="color:#e06c75">f</span><span style="color:#abb2bf">:</span><span style="color:#e06c75">ident</span><span style="color:#abb2bf"> ( $($</span><span style="color:#e06c75">e1</span><span style="color:#abb2bf">:</span><span style="color:#e06c75">expr</span><span style="color:#abb2bf">),*) ).*</span><span style="color:#7f848e;font-style:italic"> // 调用链</span></span>
<span class="line"><span style="color:#abb2bf">      $(: $</span><span style="color:#e06c75">ty</span><span style="color:#abb2bf">:</span><span style="color:#e06c75">ty</span><span style="color:#abb2bf">)?</span><span style="color:#7f848e;font-style:italic"> // 可选的类型标注</span></span>
<span class="line"><span style="color:#abb2bf">    ) =&gt; {</span></span>
<span class="line"><span style="color:#abb2bf">        {</span></span>
<span class="line"><span style="color:#abb2bf">            </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">h</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> $</span><span style="color:#e06c75">i</span><span style="color:#abb2bf">$(.$</span><span style="color:#e06c75">h</span><span style="color:#abb2bf">($($</span><span style="color:#e06c75">e0</span><span style="color:#abb2bf">),*))*;</span></span>
<span class="line"><span style="color:#abb2bf">            </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">v</span><span style="color:#abb2bf">$(: $</span><span style="color:#e06c75">ty</span><span style="color:#abb2bf">)? </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">h</span><span style="color:#abb2bf">$(.$</span><span style="color:#e06c75">f</span><span style="color:#abb2bf">($($</span><span style="color:#e06c75">e1</span><span style="color:#abb2bf">),*))*;</span></span>
<span class="line"><span style="color:#abb2bf">            </span><span style="color:#61afef">drop</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">h</span><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#abb2bf">            </span><span style="color:#e06c75">v</span></span>
<span class="line"><span style="color:#abb2bf">        }</span></span>
<span class="line"><span style="color:#abb2bf">    };</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">cell</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">RefCell</span><span style="color:#abb2bf">::</span><span style="color:#61afef">new</span><span style="color:#abb2bf">(</span><span style="color:#61afef">vec!</span><span style="color:#abb2bf">[</span><span style="color:#d19a66">1</span><span style="color:#abb2bf">, </span><span style="color:#d19a66">2</span><span style="color:#abb2bf">, </span><span style="color:#d19a66">3</span><span style="color:#abb2bf">]);</span></span>
<span class="line"><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">values</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> (</span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#61afef">with!</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">cell</span></span>
<span class="line"><span style="color:#abb2bf">    .</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">()</span></span>
<span class="line"><span style="color:#abb2bf">    #</span><span style="color:#7f848e;font-style:italic"> // 以上是可变的引用，以下是引用上的调用链</span></span>
<span class="line"><span style="color:#abb2bf">    .</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">()</span></span>
<span class="line"><span style="color:#abb2bf">    .</span><span style="color:#61afef">map</span><span style="color:#abb2bf">(</span><span style="color:#56b6c2">|</span><span style="color:#e06c75">a</span><span style="color:#56b6c2">|</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">a</span><span style="color:#abb2bf"> + </span><span style="color:#d19a66">1</span><span style="color:#abb2bf">)</span></span>
<span class="line"><span style="color:#abb2bf">    .</span><span style="color:#61afef">sum</span><span style="color:#abb2bf">()</span></span>
<span class="line"><span style="color:#abb2bf">    :</span><span style="color:#e5c07b">i32</span><span style="color:#7f848e;font-style:italic"> // 可选的类型标注</span></span>
<span class="line"><span style="color:#abb2bf">  ),</span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#61afef">with!</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">cell</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">()#.</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">().</span><span style="color:#61afef">max</span><span style="color:#abb2bf">().</span><span style="color:#61afef">cloned</span><span style="color:#abb2bf">()),</span></span>
<span class="line"><span style="color:#abb2bf">  </span><span style="color:#61afef">with!</span><span style="color:#abb2bf">(</span><span style="color:#e06c75">cell</span><span style="color:#abb2bf">.</span><span style="color:#61afef">borrow_mut</span><span style="color:#abb2bf">()#.</span><span style="color:#61afef">iter</span><span style="color:#abb2bf">().</span><span style="color:#61afef">min</span><span style="color:#abb2bf">().</span><span style="color:#61afef">cloned</span><span style="color:#abb2bf">()),</span></span>
<span class="line"><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#61afef">println!</span><span style="color:#abb2bf">(</span><span style="color:#98c379">"{:?}"</span><span style="color:#abb2bf">, </span><span style="color:#e06c75">values</span><span style="color:#abb2bf">);</span><span style="color:#7f848e;font-style:italic"> // -&gt; (9, Some(3), Some(1))</span></span>
<span class="line"></span></code></pre></article><hr class="talk-separator"><article note=""><h2 id="返回值位置的-impl-trait" tabindex="-1">返回值位置的 <code>impl Trait</code></h2><p>来自 <a href="https://this-week-in-rust.org/blog/2022/05/18/this-week-in-rust-443/" target="_blank" rel="noopener">This Week in Rust 443</a> 推荐文章 <a href="https://davidkoloski.me/blog/a-new-impl-trait-1/#citation-2" target="_blank" rel="noopener"><em>A new impl Trait 1/4</em></a>。</p><p><s>众所周知</s>，<code>impl Trait</code> 在形参位置和返回值位置是完全不同的语法糖🤯。在返回值位置，可以理解为它表示一个“<strong>静态的抽象类型🐘</strong>”，即：</p><ul><li>编译器在<strong>编译期</strong>为它确定了一个具体类型，所以<em>仍然是静态派发</em>。</li><li>但它是一个<strong>抽象类型</strong>（<a href="https://en.wikipedia.org/wiki/Abstract_type" target="_blank" rel="noopener">abstract type</a>）。在语义上，它<em>实现且仅实现</em>了 <code>Trait</code> 暴露出来的接口。</li></ul><p><code>impl Trait</code> 一般用于带有关联类型（associate type）的特征，比如 <code>Iterator</code> 或是 <code>Future</code>，它们的关联类型可能变得非常复杂，所以用 <code>impl</code> 抽象它省略掉这些类型会比较方便。隐式的推断固然方便，但最终推断出了什么类型？这里面就有可能……😈</p><p>比如博文中举出的这个例子：</p><pre class="shiki" style="background-color:#282c34"><code><span class="line"><span style="color:#c678dd">trait</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Ore</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Clone</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">print</span><span style="color:#abb2bf">(&amp;</span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">);</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">impl</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Ore</span><span style="color:#abb2bf">&gt; </span><span style="color:#e5c07b">Ore</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">for</span><span style="color:#abb2bf"> &amp;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">print</span><span style="color:#abb2bf">(&amp;</span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">) { </span><span style="color:#61afef">println!</span><span style="color:#abb2bf">(</span><span style="color:#98c379">"Ore"</span><span style="color:#abb2bf">); }</span><span style="color:#7f848e;font-style:italic"> // &lt;- print#1</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#abb2bf">#[derive(</span><span style="color:#e5c07b">Clone</span><span style="color:#abb2bf">, </span><span style="color:#e5c07b">Copy</span><span style="color:#abb2bf">)]</span></span>
<span class="line"><span style="color:#c678dd">struct</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Bauxite</span><span style="color:#abb2bf">;</span><span style="color:#7f848e;font-style:italic"> // 铝土矿（话说这个博主怎么这么喜欢挖矿啊）</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">impl</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Ore</span><span style="color:#abb2bf"> </span><span style="color:#c678dd">for</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Bauxite</span><span style="color:#abb2bf"> {</span><span style="color:#7f848e;font-style:italic"> // &lt;- Bauxite 上实现了 Clone，OK</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">print</span><span style="color:#abb2bf">(&amp;</span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">) { </span><span style="color:#61afef">println!</span><span style="color:#abb2bf">(</span><span style="color:#98c379">"Bauxite"</span><span style="color:#abb2bf">); }</span><span style="color:#7f848e;font-style:italic"> // &lt;- print#2</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">struct</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Quarry</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">&gt; {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">ore</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">,</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#c678dd">impl</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Ore</span><span style="color:#abb2bf">&gt; </span><span style="color:#e5c07b">Quarry</span><span style="color:#abb2bf">&lt;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf">&gt; {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">ore</span><span style="color:#abb2bf">(&amp;</span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">) -&gt; &amp;</span><span style="color:#e5c07b">T</span><span style="color:#abb2bf"> {</span></span>
<span class="line"><span style="color:#abb2bf">        &amp;</span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">.ore</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">mine</span><span style="color:#abb2bf">(&amp;</span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">) -&gt; </span><span style="color:#c678dd">impl</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Ore</span><span style="color:#abb2bf"> + '</span><span style="color:#e5c07b">_</span><span style="color:#abb2bf"> {</span><span style="color:#7f848e;font-style:italic"> // &lt;- 这里有一个**很可疑**的隐式生命周期</span></span>
<span class="line"><span style="color:#abb2bf">        </span><span style="color:#e5c07b">self</span><span style="color:#abb2bf">.</span><span style="color:#61afef">ore</span><span style="color:#abb2bf">().</span><span style="color:#61afef">clone</span><span style="color:#abb2bf">()</span></span>
<span class="line"><span style="color:#abb2bf">    }</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#abb2bf">#[test]</span></span>
<span class="line"><span style="color:#c678dd">fn</span><span style="color:#abb2bf"> </span><span style="color:#61afef">test_impl</span><span style="color:#abb2bf">() {</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#c678dd">let</span><span style="color:#abb2bf"> </span><span style="color:#e06c75">quarry</span><span style="color:#abb2bf"> </span><span style="color:#56b6c2">=</span><span style="color:#abb2bf"> </span><span style="color:#e5c07b">Quarry</span><span style="color:#abb2bf"> { </span><span style="color:#e06c75">ore</span><span style="color:#abb2bf">: </span><span style="color:#e5c07b">Bauxite</span><span style="color:#abb2bf"> };</span></span>
<span class="line"><span style="color:#abb2bf">    </span><span style="color:#e06c75">quarry</span><span style="color:#abb2bf">.</span><span style="color:#61afef">mine</span><span style="color:#abb2bf">().</span><span style="color:#61afef">print</span><span style="color:#abb2bf">();</span><span style="color:#7f848e;font-style:italic"> // &gt;&gt; Bauxite</span></span>
<span class="line"><span style="color:#abb2bf">}</span></span>
<span class="line"></span></code></pre><p>输出了 Bauxite，说明 <code>impl</code> 推断出来的具体类型是 <code>Bauxite</code>，派发到了 <code>print#2</code>，一切正常🤔。</p><p>但，当你删除了第一行 <code>Clone</code> 的约束后，打印出来的就变成了 Ore，派发到了 <code>print#1</code>😲。为什么？注意 <code>impl</code> 后面那个可疑的隐式生命周期……</p><p>在 <code>mine()</code> 中，<code>self.ore()</code> 的类型是 <code>&amp;T</code>，而 <code>T</code> 满足 <code>Ore</code>……</p><ul><li>如果 <code>Ore</code> 同时满足 <code>Clone</code>，那么根据 <a href="https://doc.rust-lang.org/std/ops/trait.Deref.html" target="_blank" rel="noopener"><code>Deref</code></a> 语法糖，<code>&amp;T.clone()</code> 调用的就是 <code>&lt;T as Clone&gt;::clone</code>，得到一个 <code>T</code>；</li><li>如果 <code>Ore</code> 不满足 <code>Clone</code>，那么调用的就是 <code>&lt;&amp;T as Clone&gt;::clone</code>，得到一个 <code>&amp;T</code>。</li></ul><p>注意，在这个实现块里，并没有在 <code>T</code> 上约束 <code>Clone</code>，即使 <code>Bauxite</code> 实现了 <code>Clone</code> 也会被忽略。<code>mine()</code> 的返回值是一个 <code>impl Ore</code>，所以……</p><ul><li>如果返回值是 <code>T</code>，而在实现块里约束了 <code>T</code> 实现 <code>Ore</code>，<code>T</code> 可以抽象为 <code>impl Ore</code>；</li><li>如果返回值是 <code>&amp;T</code>，实现块里约束了 <code>T</code> 实现 <code>Ore</code>，而<s>诡计多端的</s> <code>Ore</code> 声明：对所有实现了 <code>Ore</code> 的 <code>T</code>，<code>&amp;T</code> 也实现 <code>Ore</code>！所以 <code>&amp;T</code> 也可以抽象为 <code>impl Ore</code>。</li></ul><p>如果返回值不用 <code>impl</code>，那么返回 <code>&amp;T</code> 其实符合生命周期擦除条件，不用标注生命周期。但用了 <code>impl</code>，所以必须在 <code>impl</code> 后面加一个 <code>'_</code>。而拥有所有权的 <code>T</code> 当然也符合 <code>'_</code>，所以……</p><p>两种情况都编译通过，但派发到了完全不同的实际类型😵。事实上，如果 <code>Ore</code> 同时为 <code>()</code> 自动实现，而你手抖多加了一个分号把返回值变成了 <code>()</code>，但签名里又用了 <code>impl Ore</code>，编译完美通过，运行时发生什么，都不敢想了🙃！</p></article></div></article></article></main></main><!----><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{"store":{"title":"","webfont":{"Noto Sans":false,"Noto Serif":false,"Noto Sans CJK SC":false,"Noto Serif CJK SC":false,"JetBrains Mono":false},"accentColors":{"light-accent":"#2177B8","light-secondary":"#003A70","dark-accent":"#FBB929","dark-secondary":"#FFE900"}}}}'</script><script>!function(){var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,a=localStorage.getItem("color-scheme")||"auto",t=(document.documentElement.className="dark"===a||t&&"light"!==a?"dark":"",localStorage.getItem("typesetting::accent_color"));if(t){a=JSON.parse(t),t=Object.entries(a).map(e=>`--accent-${e[0]}: ${e[1]};`).join("\n");let e=document.createElement("style");e.type="text/css",e.innerText=`:root{${t}}`,document.head.appendChild(e)}}()</script><link rel="stylesheet" href="/assets/app.7456a1e8.css"><link rel="stylesheet" href="/assets/TheArticle.080d4a8a.css"></body></html>