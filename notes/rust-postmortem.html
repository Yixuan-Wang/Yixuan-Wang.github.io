<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="apple-touch-icon" href="/pwa-192x192.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#00aba9"><meta name="msapplication-TileColor" content="#00aba9"><meta name="theme-color" content="#ffffff"><script type="module" async="" crossorigin="" src="/assets/app.6b8d948f.js"></script><link rel="modulepreload" href="/assets/vendor.acceb4fd.js"><style>button[data-v-5764c721]{padding:.25rem;font-size:1.125rem;line-height:1.75rem;color:var(--color-accent)}button[data-v-5764c721]:hover{color:var(--color-secondary)}#app{display:grid;grid-template-rows:auto 1fr auto;grid-template-columns:100%;margin-left:1rem;margin-right:1rem;height:100%}@media (min-width:1024px){#app{margin-left:0;margin-right:0}}*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:currentColor}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}h1,h2{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}strong{font-weight:bolder}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:1em}button{font-family:inherit;font-size:100%;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}button{-webkit-appearance:button;background-color:transparent;background-image:none}h1,h2,hr,p,pre{margin:0}button{cursor:pointer}svg{display:block;vertical-align:middle}.my-4{margin-top:1rem;margin-bottom:1rem}.mb-8{margin-bottom:2rem}.mt-4{margin-top:1rem}.inline-block{display:inline-block}.flex{display:flex}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-start{justify-content:flex-start}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{grid-gap:.25rem;gap:.25rem}.gap-2{grid-gap:.5rem;gap:.5rem}.gap-3{grid-gap:.75rem;gap:.75rem}.gap-x-1{grid-column-gap:.25rem;column-gap:.25rem}.gap-y-0\.5{grid-row-gap:.125rem;row-gap:.125rem}.rounded{border-radius:.25rem}.bg-acc,.hover\:bg-acc:hover{background-color:var(--color-accent)}.hover\:bg-sec:hover{background-color:var(--color-secondary)}.px-2{padding-left:.5rem;padding-right:.5rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.text-left{text-align:left}.font-mono{font-family:var(--font-mono)}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.hover\:text-acc:hover,.text-acc{color:var(--color-accent)}.hover\:text-bgd:hover,.text-bgd{color:var(--color-background)}.text-sec{color:var(--color-secondary)}.ring-2{--un-ring-inset:var(--un-empty, );/*!*//*!*/--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgba(147,197,253,0.5)}.ring-2{--un-ring-width:2px;--un-ring-offset-shadow:var(--un-ring-inset) 0 0 0 var(--un-ring-offset-width) var(--un-ring-offset-color);--un-ring-shadow:var(--un-ring-inset) 0 0 0 calc(var(--un-ring-width) + var(--un-ring-offset-width)) var(--un-ring-color);box-shadow:var(--un-ring-offset-shadow),var(--un-ring-shadow),var(--un-shadow,0 0 #0000)}.ring-acc{--un-ring-color:var(--color-accent)}.ring-fgd{--un-ring-color:var(--color-foreground)}.ring-sec{--un-ring-color:var(--color-secondary)}.ring-inset{--un-ring-inset:inset}:root{--color-accent:var(--accent-light-accent, #003A70);--color-secondary:var(--accent-light-secondary, #61649f);--color-background:#F5F5F5;--color-foreground:#1D252D;--color-dim:#737C7B;--font-sans:"Noto Sans",var(--custom-font-sans, sans-serif),"SF Pro",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Avenir Next","Helvetica Neue",sans-serif;--font-serif:"Noto Serif",var(--custom-font-serif, serif),"Noto Serif","New York","Roboto Slab",Cambria,Georgia,Times,"Times New Roman",serif;--font-mono:"JetBrains Mono","SF Mono","Roboto Mono",Menlo,"Cascadia Code",Consolas,monospace}html{height:100%;margin:0;padding:0;text-align:center;font-size:1rem;line-height:1.5rem;overflow:auto;overflow:overlay;background-color:var(--color-background);color:var(--color-foreground);font-family:var(--font-sans)}html:not(.dark) .shiki-dark{display:none}body{height:100%;margin:auto;padding:0;max-width:75ch}svg{width:1.25em;height:1.25em;display:inline;vertical-align:sub}h1{font-size:1.875rem;line-height:2.25rem;font-weight:700}button{outline:2px solid transparent!important;outline-offset:2px!important}.transition-lively,button{-webkit-transition-property:background-color,border-color,color,fill,stroke,opacity,-webkit-box-shadow,-webkit-transform,filter,backdrop-filter;-o-transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,-webkit-box-shadow,transform,-webkit-transform,filter,backdrop-filter;-webkit-transition-timing-function:cubic-bezier(.4,0,1,1);-o-transition-timing-function:cubic-bezier(.4,0,1,1);transition-timing-function:cubic-bezier(.4,0,1,1);-webkit-transition-duration:.2s;-o-transition-duration:.2s;transition-duration:.2s}.transition-lively:hover,button:hover{-webkit-transition-timing-function:cubic-bezier(0,0,.2,1);-o-transition-timing-function:cubic-bezier(0,0,.2,1);transition-timing-function:cubic-bezier(0,0,.2,1);-webkit-transition-duration:.3s;-o-transition-duration:.3s;transition-duration:.3s}#md a,#md a *{text-decoration-skip-ink:auto;color:var(--color-accent);transition:all .2s ease-in}#md a :hover,#md a:hover{color:var(--color-secondary);transition:all .3s ease-out}#md em{padding-right:.25ch}#md h2{margin:1.25em 0 .75em;font-family:var(--font-serif);font-weight:700}#md h2{font-size:1.5em}#md p{margin:1em 0}#md h2:first-child,#md p:first-child,#md pre:first-child{margin-top:0}#md h2:last-child,#md p:last-child,#md pre:last-child{margin-bottom:0}#md a{text-decoration:underline;text-decoration-skip-ink:auto}#md hr{border:0;height:0;border-bottom:1px solid var(--color-foreground)}#md hr.talk-separator{height:1.5em;border:none;overflow:visible;text-align:center}#md hr.talk-separator:after{position:relative;content:"***";letter-spacing:.5em;background:0 0}#md hr.talk-separator+h2{margin-top:0}#md pre pre{border-radius:.25rem;padding:1em;max-width:100%;overflow:auto}#md p code{font-size:.95rem;padding:.2em}#md code,#md pre{font-family:var(--font-mono);line-height:154%}#md pre{margin:1em 0}</style><link rel="preload" href="/assets/app.902f5b30.css" as="style"><link rel="modulepreload" crossorigin="" href="/assets/rust-postmortem.0d2f1bc6.js"><link rel="preload" href="/assets/rust-postmortem.cbcdf903.css" as="style"><link rel="modulepreload" crossorigin="" href="/assets/TheArticle.72ea6b3b.js"><link rel="preload" href="/assets/TheArticle.25f0d059.css" as="style"><title>In Rust We Bust | Pak</title><meta name="description" content="Rust 语言的踩坑记录。"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css" integrity="sha384-zTROYFVGOfTw7JV7KUu8udsvW2fx4lWOsCEDqhBreBwlHI4ioVRtmIvEThzJHGET" crossorigin="anonymous"><meta name="head:count" content="2"></head><body><div id="app" data-server-rendered="true"><!--[--><header class="flex justify-between items-center my-4 gap-2" data-v-5764c721=""><nav class="inline-block px-2 py-1 rounded bg-acc text-bgd font-bold transition-lively hover:bg-sec" data-v-5764c721=""><a href="/" class="" data-v-5764c721="">Pak</a></nav><nav class="flex justify-between items-center gap-3" data-v-5764c721=""><button data-v-5764c721=""><a href="/archive" class="" data-v-5764c721=""><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24" data-v-5764c721=""><path d="M14 17H7v-2h7m3-2H7v-2h10m0-2H7V7h10m2-4H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor"></path></svg></a></button><button data-v-5764c721=""><a href="/posts" class="" data-v-5764c721=""><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24" data-v-5764c721=""><path d="M13 9V3.5L18.5 9M6 2c-1.11 0-2 .89-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6H6z" fill="currentColor"></path></svg></a></button><button data-v-5764c721=""><a href="/sheets" class="" data-v-5764c721=""><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24" data-v-5764c721=""><path d="M4 3h16a2 2 0 0 1 2 2v15a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2m0 4v3h4V7H4m6 0v3h4V7h-4m10 3V7h-4v3h4M4 12v3h4v-3H4m0 8h4v-3H4v3m6-8v3h4v-3h-4m0 8h4v-3h-4v3m10 0v-3h-4v3h4m0-8h-4v3h4v-3z" fill="currentColor"></path></svg></a></button><button data-v-5764c721=""><a href="/notes" class="" data-v-5764c721=""><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24" data-v-5764c721=""><path d="M14 10V4.5l5.5 5.5M5 3c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9l-6-6H5z" fill="currentColor"></path></svg></a></button></nav></header><main class="text-left"><main class="mb-8"><article class="text-left"><!--[--><header class="flex flex-col justify-start items-start gap-2 mt-4 mb-8"><h1>In Rust We Bust</h1><div class="flex flex-wrap gap-x-1 gap-y-0.5 justify-start items-center"><span class="flex justify-center text-lg"><a href="/notes" class=""><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24" class="transition-lively hover:text-acc"><path d="M14 10V4.5l5.5 5.5M5 3c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9l-6-6H5z" fill="currentColor"></path></svg></a></span><span class="flex gap-1 justify-center items-center"><span class="inline-block text-xs rounded px-2 py-1 font-mono font-bold transition-lively ring-inset ring-2 ring-fgd"><!--[--><time>04/14/2022</time><!--]--></span><span class="inline-block text-xs rounded px-2 py-1 font-mono font-bold transition-lively ring-inset ring-2 ring-fgd"><!--[-->zh-Hans<!--]--></span></span><span class="flex gap-1 justify-center items-center"><span class="inline-block text-xs rounded px-2 py-1 font-mono font-bold transition-lively ring-inset ring-2 ring-acc text-acc hover:bg-acc hover:text-bgd"><!--[--><a href="/categories/comp" class="">Computer</a><!--]--></span></span><span class="flex gap-1 justify-center items-center"><!--[--><span class="inline-block text-xs rounded px-2 py-1 font-mono font-bold transition-lively ring-inset ring-2 ring-sec text-sec hover:bg-sec hover:text-bgd"><!--[--><a href="/tags?tag=rust" class=""> @rust</a><!--]--></span><span class="inline-block text-xs rounded px-2 py-1 font-mono font-bold transition-lively ring-inset ring-2 ring-sec text-sec hover:bg-sec hover:text-bgd"><!--[--><a href="/tags?tag=pl" class=""> @pl</a><!--]--></span><!--]--></span><span class="flex gap-1 justify-center items-center"><!--[--><!--]--></span></div></header><section id="md"><div><p>Rust 语言的踩坑记录。</p><!-- more --><p><s>对 <code>rustc</code> 施用 <a href="https://harrypotter.fandom.com/wiki/Silencing_Charm" target="_blank" rel="noopener"><code>Silencio</code></a> 可不能解决问题</s>。</p><h2 id="refcell-和作用域" tabindex="-1"><code>RefCell</code> 和作用域</h2><p>Rust 通过 <code>std::cell</code> 提供的“内部可变性”看起来很爽——可以把一个不可变的数据的一部分搞成可变的。其中的 <code>RefCell</code> 可以把<s>美名远扬</s>的编译期 <code>borrowck</code> 搞到运行期去，实现往不可变数据内部指一个可写的指针 <code>RefMut</code> 的功能🤗。</p><p>那么能不能把原数据用 <code>RefCell</code> 一包，然后直接把 <code>&amp;x, &amp;mut x</code> 替换成 <code>x.borrow(), x.borrow_mut()</code> ？编译器会答应，但作用域问题可能会导致运行时 panic🙃。</p><p>考虑下面一段代码：</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#eceff4">#[</span><span style="color:#d8dEE9FF">allow</span><span style="color:#eceff4">(</span><span style="color:#d8dEE9FF">unused</span><span style="color:#eceff4">)]</span></span>
<span class="line"><span style="color:#81a1c1">fn</span><span style="color:#d8dEE9FF"> </span><span style="color:#88c0d0">main</span><span style="color:#eceff4">()</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">mut</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">x</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> Option</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">i32</span><span style="color:#eceff4">&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> None</span><span style="color:#eceff4">;</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">y</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&amp;</span><span style="color:#d8dee9">x</span><span style="color:#eceff4">;</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">if</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">y</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">is_none</span><span style="color:#eceff4">()</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">        </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">z</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&amp;mut</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">x</span><span style="color:#eceff4">;</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#eceff4">}</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">#[allow(unused)]</span></span>
<span class="line"><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">main</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> </span><span style="color:#cf222e">mut</span><span style="color:#24292f"> x</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt; </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">None</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> y </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">x;</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">if</span><span style="color:#24292f"> y</span><span style="color:#cf222e">.</span><span style="color:#8250df">is_none</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">let</span><span style="color:#24292f"> z </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> x;</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>问题全然无，编译通过。<code>y</code> 是不可变引用，但是在 <code>if</code> 的表达式里只用过一次就没再用过，因此 <code>z</code> 可以高高兴兴地借出可变引用。看看 MIR：</p><pre><code class="language-sh"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#d8dEE9FF">$ rustc src/main.rs --emit mir</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">$ rustc src/main.rs --emit mir</span></span>
<span class="line"></span></code></pre></div></code></pre><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#d8dee9">scope</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">1</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">debug</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">x</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_1</span><span style="color:#eceff4">;</span><span style="color:#616e88">                   // in scope 1</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_2</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&amp;</span><span style="color:#d8dEE9FF">std</span><span style="color:#81a1c1">::</span><span style="color:#d8dEE9FF">option</span><span style="color:#81a1c1">::</span><span style="color:#d8dEE9FF">Option</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">i32</span><span style="color:#eceff4">&gt;;</span><span style="color:#616e88"> // in scope 1</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">scope</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">2</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">        </span><span style="color:#d8dee9">debug</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">y</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_2</span><span style="color:#eceff4">;</span><span style="color:#616e88">               // in scope 2</span></span>
<span class="line"><span style="color:#d8dEE9FF">        </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_5</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&amp;mut</span><span style="color:#d8dEE9FF"> std</span><span style="color:#81a1c1">::</span><span style="color:#d8dEE9FF">option</span><span style="color:#81a1c1">::</span><span style="color:#d8dEE9FF">Option</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">i32</span><span style="color:#eceff4">&gt;;</span><span style="color:#616e88"> // in scope 2</span></span>
<span class="line"><span style="color:#d8dEE9FF">        </span><span style="color:#d8dee9">scope</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">3</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">            </span><span style="color:#d8dee9">debug</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">z</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_5</span><span style="color:#eceff4">;</span><span style="color:#616e88">           // in scope 3</span></span>
<span class="line"><span style="color:#d8dEE9FF">        </span><span style="color:#eceff4">}</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#eceff4">}</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d8dee9">bb0</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#88c0d0">discriminant</span><span style="color:#eceff4">(</span><span style="color:#d8dee9">_1</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">0</span><span style="color:#eceff4">;</span><span style="color:#616e88">            // scope 0</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">_2</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&amp;</span><span style="color:#d8dee9">_1</span><span style="color:#eceff4">;</span><span style="color:#616e88">                        // scope 1</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">_4</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_2</span><span style="color:#eceff4">;</span><span style="color:#616e88">                         // scope 2</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">_3</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> Option</span><span style="color:#81a1c1">::</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">i32</span><span style="color:#eceff4">&gt;</span><span style="color:#81a1c1">::</span><span style="color:#88c0d0">is_none</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">move</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_4</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">-&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb1</span><span style="color:#eceff4">;</span><span style="color:#616e88"> // scope 2</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d8dee9">bb1</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#88c0d0">switchInt</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">move</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_3</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">-&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">[</span><span style="color:#81a1c1">false:</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb3</span><span style="color:#eceff4">,</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">otherwise</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb2</span><span style="color:#eceff4">];</span><span style="color:#616e88"> // scope 2</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d8dee9">bb2</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">_5</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&amp;mut</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_1</span><span style="color:#eceff4">;</span><span style="color:#616e88">                    // scope 2</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">goto</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">-&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb3</span><span style="color:#eceff4">;</span><span style="color:#616e88">                     // scope 2</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d8dee9">bb3</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">return</span><span style="color:#eceff4">;</span><span style="color:#616e88">                          // scope 0</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">scope </span><span style="color:#0550ae">1</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    debug x </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> _1;</span><span style="color:#6e7781">                   // in scope 1</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> _2</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#953800">std</span><span style="color:#cf222e">::</span><span style="color:#953800">option</span><span style="color:#cf222e">::</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;;</span><span style="color:#6e7781"> // in scope 1</span></span>
<span class="line"><span style="color:#24292f">    scope </span><span style="color:#0550ae">2</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        debug y </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> _2;</span><span style="color:#6e7781">               // in scope 2</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">let</span><span style="color:#24292f"> _5</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#cf222e">::</span><span style="color:#953800">option</span><span style="color:#cf222e">::</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;;</span><span style="color:#6e7781"> // in scope 2</span></span>
<span class="line"><span style="color:#24292f">        scope </span><span style="color:#0550ae">3</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">            debug z </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> _5;</span><span style="color:#6e7781">           // in scope 3</span></span>
<span class="line"><span style="color:#24292f">        }</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb0</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">discriminant</span><span style="color:#24292f">(_1) </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#0550ae">0</span><span style="color:#24292f">;</span><span style="color:#6e7781">            // scope 0</span></span>
<span class="line"><span style="color:#24292f">    _2 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">_1;</span><span style="color:#6e7781">                        // scope 1</span></span>
<span class="line"><span style="color:#24292f">    _4 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> _2;</span><span style="color:#6e7781">                         // scope 2</span></span>
<span class="line"><span style="color:#24292f">    _3 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">Option</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;</span><span style="color:#cf222e">::</span><span style="color:#8250df">is_none</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _4) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> bb1;</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb1</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">switchInt</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _3) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> [</span><span style="color:#0550ae">false</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb3, otherwise</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb2];</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb2</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    _5 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> _1;</span><span style="color:#6e7781">                    // scope 2</span></span>
<span class="line"><span style="color:#24292f">    goto </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> bb3;</span><span style="color:#6e7781">                     // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb3</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">return</span><span style="color:#24292f">;</span><span style="color:#6e7781">                          // scope 0</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p><code>y(_2)</code> 只在基本块 <code>0</code> 出现。跳转到基本块 <code>2</code>，<code>z(_5)</code> 借可变引用的时候没有 <code>x</code> 的不可变引用了，<code>borrowck</code> 放行。</p><p>如果替换成 <code>RefCell</code> 呢？</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#eceff4">#[</span><span style="color:#d8dEE9FF">allow</span><span style="color:#eceff4">(</span><span style="color:#d8dEE9FF">unused</span><span style="color:#eceff4">)]</span></span>
<span class="line"><span style="color:#81a1c1">fn</span><span style="color:#d8dEE9FF"> </span><span style="color:#88c0d0">main</span><span style="color:#eceff4">()</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">x</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> RefCell</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">Option</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">i32</span><span style="color:#eceff4">&gt;&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> RefCell</span><span style="color:#81a1c1">::</span><span style="color:#88c0d0">new</span><span style="color:#eceff4">(</span><span style="color:#d8dEE9FF">None</span><span style="color:#eceff4">);</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">y</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">x</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">borrow</span><span style="color:#eceff4">();</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">if</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">y</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">is_none</span><span style="color:#eceff4">()</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">        </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">z</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">x</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">borrow_mut</span><span style="color:#eceff4">();</span><span style="color:#616e88"> // &lt;- thread 'main' panicked at 'already borrowed: BorrowMutError'</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#eceff4">}</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">#[allow(unused)]</span></span>
<span class="line"><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">main</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> x</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt; </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#953800">None</span><span style="color:#24292f">);</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> y </span><span style="color:#cf222e">=</span><span style="color:#24292f"> x</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">if</span><span style="color:#24292f"> y</span><span style="color:#cf222e">.</span><span style="color:#8250df">is_none</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">let</span><span style="color:#24292f"> z </span><span style="color:#cf222e">=</span><span style="color:#24292f"> x</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">();</span><span style="color:#6e7781"> // &lt;- thread 'main' panicked at 'already borrowed: BorrowMutError'</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>panic 了。为什么呢？</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#d8dee9">scope</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">1</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">debug</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">x</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_1</span><span style="color:#eceff4">;</span><span style="color:#616e88">                   // in scope 1</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_3</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> std</span><span style="color:#81a1c1">::</span><span style="color:#d8dEE9FF">cell</span><span style="color:#81a1c1">::</span><span style="color:#d8dEE9FF">Ref</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dee9">std</span><span style="color:#81a1c1">::</span><span style="color:#d8dee9">option</span><span style="color:#81a1c1">::</span><span style="color:#d8dEE9FF">Option</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">i32</span><span style="color:#eceff4">&gt;&gt;;</span><span style="color:#616e88"> // in scope 1</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">scope</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">2</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">        </span><span style="color:#d8dee9">debug</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">y</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_3</span><span style="color:#eceff4">;</span><span style="color:#616e88">               // in scope 2</span></span>
<span class="line"><span style="color:#d8dEE9FF">        </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_9</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> std</span><span style="color:#81a1c1">::</span><span style="color:#d8dEE9FF">cell</span><span style="color:#81a1c1">::</span><span style="color:#d8dEE9FF">RefMut</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dee9">std</span><span style="color:#81a1c1">::</span><span style="color:#d8dee9">option</span><span style="color:#81a1c1">::</span><span style="color:#d8dEE9FF">Option</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">i32</span><span style="color:#eceff4">&gt;&gt;;</span><span style="color:#616e88"> // in scope 2</span></span>
<span class="line"><span style="color:#d8dEE9FF">        </span><span style="color:#d8dee9">scope</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">3</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">            </span><span style="color:#d8dee9">debug</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">z</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_9</span><span style="color:#eceff4">;</span><span style="color:#616e88">           // in scope 3</span></span>
<span class="line"><span style="color:#d8dEE9FF">        </span><span style="color:#eceff4">}</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#eceff4">}</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d8dee9">bb0</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#88c0d0">discriminant</span><span style="color:#eceff4">(</span><span style="color:#d8dee9">_2</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">0</span><span style="color:#eceff4">;</span><span style="color:#616e88">            // scope 0</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">_1</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> RefCell</span><span style="color:#81a1c1">::</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">Option</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">i32</span><span style="color:#eceff4">&gt;&gt;</span><span style="color:#81a1c1">::</span><span style="color:#88c0d0">new</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">move</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_2</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">-&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb1</span><span style="color:#eceff4">;</span><span style="color:#616e88"> // scope 0</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d8dee9">bb1</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">_4</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&amp;</span><span style="color:#d8dee9">_1</span><span style="color:#eceff4">;</span><span style="color:#616e88">                        // scope 1</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">_3</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> RefCell</span><span style="color:#81a1c1">::</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">Option</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">i32</span><span style="color:#eceff4">&gt;&gt;</span><span style="color:#81a1c1">::</span><span style="color:#88c0d0">borrow</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">move</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_4</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">-&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb2</span><span style="color:#eceff4">;</span><span style="color:#616e88"> // scope 1</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d8dee9">bb2</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">_8</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&amp;</span><span style="color:#d8dee9">_3</span><span style="color:#eceff4">;</span><span style="color:#616e88">                        // scope 2</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">_7</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">Ref</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">Option</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">i32</span><span style="color:#eceff4">&gt;&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">as</span><span style="color:#d8dEE9FF"> Deref</span><span style="color:#eceff4">&gt;</span><span style="color:#81a1c1">::</span><span style="color:#88c0d0">deref</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">move</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_8</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">-&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">[</span><span style="color:#81a1c1">return:</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb3</span><span style="color:#eceff4">,</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">unwind</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb9</span><span style="color:#eceff4">];</span><span style="color:#616e88"> // scope 2</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d8dee9">bb3</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">_6</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_7</span><span style="color:#eceff4">;</span><span style="color:#616e88">                         // scope 2</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">_5</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> Option</span><span style="color:#81a1c1">::</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">i32</span><span style="color:#eceff4">&gt;</span><span style="color:#81a1c1">::</span><span style="color:#88c0d0">is_none</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">move</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_6</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">-&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">[</span><span style="color:#81a1c1">return:</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb4</span><span style="color:#eceff4">,</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">unwind</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb9</span><span style="color:#eceff4">];</span><span style="color:#616e88"> // scope 2</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d8dee9">bb4</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#88c0d0">switchInt</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">move</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_5</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">-&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">[</span><span style="color:#81a1c1">false:</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb7</span><span style="color:#eceff4">,</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">otherwise</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb5</span><span style="color:#eceff4">];</span><span style="color:#616e88"> // scope 2</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d8dee9">bb5</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">_10</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&amp;</span><span style="color:#d8dee9">_1</span><span style="color:#eceff4">;</span><span style="color:#616e88">                       // scope 2</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#d8dee9">_9</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> RefCell</span><span style="color:#81a1c1">::</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">Option</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">i32</span><span style="color:#eceff4">&gt;&gt;</span><span style="color:#81a1c1">::</span><span style="color:#88c0d0">borrow_mut</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">move</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">_10</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">-&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">[</span><span style="color:#81a1c1">return:</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb6</span><span style="color:#eceff4">,</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">unwind</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb9</span><span style="color:#eceff4">];</span><span style="color:#616e88"> // scope 2</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616e88">/* z 在这里析构 */</span></span>
<span class="line"><span style="color:#d8dee9">bb6</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#88c0d0">drop</span><span style="color:#eceff4">(</span><span style="color:#d8dee9">_9</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">-&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">[</span><span style="color:#81a1c1">return:</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb7</span><span style="color:#eceff4">,</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">unwind</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb9</span><span style="color:#eceff4">];</span><span style="color:#616e88"> // scope 2</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616e88">/* y 在这里才析构 */</span></span>
<span class="line"><span style="color:#d8dee9">bb7</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#88c0d0">drop</span><span style="color:#eceff4">(</span><span style="color:#d8dee9">_3</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">-&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">bb8</span><span style="color:#eceff4">;</span><span style="color:#616e88">                 // scope 1</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#d8dee9">bb8</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">return</span><span style="color:#eceff4">;</span><span style="color:#616e88">                          // scope 0</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#616e88">// ...</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">scope </span><span style="color:#0550ae">1</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    debug x </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> _1;</span><span style="color:#6e7781">                   // in scope 1</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> _3</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#cf222e">::</span><span style="color:#953800">cell</span><span style="color:#cf222e">::</span><span style="color:#953800">Ref</span><span style="color:#24292f">&lt;std</span><span style="color:#cf222e">::</span><span style="color:#24292f">option</span><span style="color:#cf222e">::</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt;;</span><span style="color:#6e7781"> // in scope 1</span></span>
<span class="line"><span style="color:#24292f">    scope </span><span style="color:#0550ae">2</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        debug y </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> _3;</span><span style="color:#6e7781">               // in scope 2</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">let</span><span style="color:#24292f"> _9</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#cf222e">::</span><span style="color:#953800">cell</span><span style="color:#cf222e">::</span><span style="color:#953800">RefMut</span><span style="color:#24292f">&lt;std</span><span style="color:#cf222e">::</span><span style="color:#24292f">option</span><span style="color:#cf222e">::</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt;;</span><span style="color:#6e7781"> // in scope 2</span></span>
<span class="line"><span style="color:#24292f">        scope </span><span style="color:#0550ae">3</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">            debug z </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> _9;</span><span style="color:#6e7781">           // in scope 3</span></span>
<span class="line"><span style="color:#24292f">        }</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb0</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">discriminant</span><span style="color:#24292f">(_2) </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#0550ae">0</span><span style="color:#24292f">;</span><span style="color:#6e7781">            // scope 0</span></span>
<span class="line"><span style="color:#24292f">    _1 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt;</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _2) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> bb1;</span><span style="color:#6e7781"> // scope 0</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb1</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    _4 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">_1;</span><span style="color:#6e7781">                        // scope 1</span></span>
<span class="line"><span style="color:#24292f">    _3 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt;</span><span style="color:#cf222e">::</span><span style="color:#8250df">borrow</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _4) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> bb2;</span><span style="color:#6e7781"> // scope 1</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb2</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    _8 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">_3;</span><span style="color:#6e7781">                        // scope 2</span></span>
<span class="line"><span style="color:#24292f">    _7 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> &lt;</span><span style="color:#953800">Ref</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt; </span><span style="color:#cf222e">as</span><span style="color:#24292f"> </span><span style="color:#953800">Deref</span><span style="color:#24292f">&gt;</span><span style="color:#cf222e">::</span><span style="color:#8250df">deref</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _8) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> [</span><span style="color:#cf222e">return:</span><span style="color:#24292f"> bb3, unwind</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb9];</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb3</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    _6 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> _7;</span><span style="color:#6e7781">                         // scope 2</span></span>
<span class="line"><span style="color:#24292f">    _5 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">Option</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;</span><span style="color:#cf222e">::</span><span style="color:#8250df">is_none</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _6) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> [</span><span style="color:#cf222e">return:</span><span style="color:#24292f"> bb4, unwind</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb9];</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb4</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">switchInt</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _5) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> [</span><span style="color:#0550ae">false</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb7, otherwise</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb5];</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb5</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    _10 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">_1;</span><span style="color:#6e7781">                       // scope 2</span></span>
<span class="line"><span style="color:#24292f">    _9 </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt;</span><span style="color:#cf222e">::</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">(</span><span style="color:#cf222e">move</span><span style="color:#24292f"> _10) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> [</span><span style="color:#cf222e">return:</span><span style="color:#24292f"> bb6, unwind</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb9];</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6e7781">/* z 在这里析构 */</span></span>
<span class="line"><span style="color:#24292f">bb6</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">drop</span><span style="color:#24292f">(_9) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> [</span><span style="color:#cf222e">return:</span><span style="color:#24292f"> bb7, unwind</span><span style="color:#cf222e">:</span><span style="color:#24292f"> bb9];</span><span style="color:#6e7781"> // scope 2</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6e7781">/* y 在这里才析构 */</span></span>
<span class="line"><span style="color:#24292f">bb7</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">drop</span><span style="color:#24292f">(_3) </span><span style="color:#cf222e">-&gt;</span><span style="color:#24292f"> bb8;</span><span style="color:#6e7781">                 // scope 1</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292f">bb8</span><span style="color:#cf222e">:</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">return</span><span style="color:#24292f">;</span><span style="color:#6e7781">                          // scope 0</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6e7781">// ...</span></span>
<span class="line"></span></code></pre></div></code></pre><p>作用域是一样的啊？但是注意，<code>y(_3)</code> 从 <code>RefCell</code> 借出的 <code>Ref</code> 是智能指针，需要析构这一步，它一直保持到 <code>if</code> 作用域的尾部，也就是基本块 <code>7</code> 才析构！在此之前基本块 <code>5</code> 要求借出 <code>RefMut</code>，于是当场 panic😱。</p><p>怎么解决呢？手动 <code>drop()</code>🤪！事实上，<code>mem::drop</code> 的文档已经给出了类似的<a href="https://doc.rust-lang.org/std/mem/fn.drop.html#examples" target="_blank" rel="noopener">例子</a>。</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#eceff4">#[</span><span style="color:#d8dEE9FF">allow</span><span style="color:#eceff4">(</span><span style="color:#d8dEE9FF">unused</span><span style="color:#eceff4">)]</span></span>
<span class="line"><span style="color:#81a1c1">fn</span><span style="color:#d8dEE9FF"> </span><span style="color:#88c0d0">main</span><span style="color:#eceff4">()</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">x</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> RefCell</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">Option</span><span style="color:#eceff4">&lt;</span><span style="color:#d8dEE9FF">i32</span><span style="color:#eceff4">&gt;&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> RefCell</span><span style="color:#81a1c1">::</span><span style="color:#88c0d0">new</span><span style="color:#eceff4">(</span><span style="color:#d8dEE9FF">None</span><span style="color:#eceff4">);</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">y</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">x</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">borrow</span><span style="color:#eceff4">();</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">if</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">b</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">y</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">is_none</span><span style="color:#eceff4">();</span><span style="color:#d8dEE9FF"> </span><span style="color:#88c0d0">drop</span><span style="color:#eceff4">(</span><span style="color:#d8dee9">y</span><span style="color:#eceff4">);</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">b</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">}</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">        </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">z</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">x</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">borrow_mut</span><span style="color:#eceff4">();</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#eceff4">}</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#24292f">#[allow(unused)]</span></span>
<span class="line"><span style="color:#cf222e">fn</span><span style="color:#24292f"> </span><span style="color:#8250df">main</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> x</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#24292f">&lt;</span><span style="color:#953800">Option</span><span style="color:#24292f">&lt;</span><span style="color:#953800">i32</span><span style="color:#24292f">&gt;&gt; </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#953800">None</span><span style="color:#24292f">);</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">let</span><span style="color:#24292f"> y </span><span style="color:#cf222e">=</span><span style="color:#24292f"> x</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">if</span><span style="color:#24292f"> { </span><span style="color:#cf222e">let</span><span style="color:#24292f"> b </span><span style="color:#cf222e">=</span><span style="color:#24292f"> y</span><span style="color:#cf222e">.</span><span style="color:#8250df">is_none</span><span style="color:#24292f">(); </span><span style="color:#8250df">drop</span><span style="color:#24292f">(y); b } {</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#cf222e">let</span><span style="color:#24292f"> z </span><span style="color:#cf222e">=</span><span style="color:#24292f"> x</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><hr class="talk-separator"><h2 id="初始化器也是表达式" tabindex="-1">初始化器也是表达式</h2><p><s>这不是显然的吗</s>？</p><p>元组（tuple）和数组（array）都是 Rust 的基本类型（primitive type）。元组的初始化器用 <code>()</code>，数组用 <code>[]</code>，分隔符是 <code>,</code>。虽然初始化器<em>显然</em>是表达式，但有时候逗号一加，就难免想这样写：</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">cell</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> RefCell</span><span style="color:#81a1c1">::</span><span style="color:#88c0d0">new</span><span style="color:#eceff4">(</span><span style="color:#88c0d0">vec!</span><span style="color:#eceff4">[</span><span style="color:#b48ead">1</span><span style="color:#eceff4">,</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">2</span><span style="color:#eceff4">,</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">3</span><span style="color:#eceff4">]);</span></span>
<span class="line"><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">values</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">(</span></span>
<span class="line"><span style="color:#d8dEE9FF">  </span><span style="color:#d8dee9">cell</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">borrow_mut</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">iter</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">max</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">cloned</span><span style="color:#eceff4">(),</span></span>
<span class="line"><span style="color:#d8dEE9FF">  </span><span style="color:#d8dee9">cell</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">borrow_mut</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">iter</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">min</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">cloned</span><span style="color:#eceff4">(),</span><span style="color:#d8dEE9FF"> </span></span>
<span class="line"><span style="color:#d8dEE9FF">  </span><span style="color:#616e88">/*   ^^^^^^^^^^ </span></span>
<span class="line"><span style="color:#616e88">       thread 'main' panicked at 'already borrowed: BorrowMutError'</span></span>
<span class="line"><span style="color:#616e88">  */</span></span>
<span class="line"><span style="color:#eceff4">);</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> cell </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#8250df">vec!</span><span style="color:#24292f">[</span><span style="color:#0550ae">1</span><span style="color:#24292f">, </span><span style="color:#0550ae">2</span><span style="color:#24292f">, </span><span style="color:#0550ae">3</span><span style="color:#24292f">]);</span></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> values </span><span style="color:#cf222e">=</span><span style="color:#24292f"> (</span></span>
<span class="line"><span style="color:#24292f">  cell</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">max</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">cloned</span><span style="color:#24292f">(),</span></span>
<span class="line"><span style="color:#24292f">  cell</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">min</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">cloned</span><span style="color:#24292f">(), </span></span>
<span class="line"><span style="color:#24292f">  </span><span style="color:#6e7781">/*   ^^^^^^^^^^ </span></span>
<span class="line"><span style="color:#6e7781">       thread 'main' panicked at 'already borrowed: BorrowMutError'</span></span>
<span class="line"><span style="color:#6e7781">  */</span></span>
<span class="line"><span style="color:#24292f">);</span></span>
<span class="line"></span></code></pre></div></code></pre><p>于是就吃了一个 panic。尽管用逗号隔开了，但<strong>表达式里面的临时变量仍然会生存到表达式的结束</strong>，函数调用的实参同理。考虑下面一个简单的例子就知道为什么要这样了：</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">mut</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">i</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">42</span><span style="color:#eceff4">;</span></span>
<span class="line"><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">tuple</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span><span style="color:#d8dee9">i</span><span style="color:#eceff4">,</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&amp;mut</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">i</span><span style="color:#eceff4">);</span><span style="color:#616e88"> // 显然不行吧</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> </span><span style="color:#cf222e">mut</span><span style="color:#24292f"> i </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#0550ae">42</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> tuple </span><span style="color:#cf222e">=</span><span style="color:#24292f"> (</span><span style="color:#cf222e">&amp;</span><span style="color:#24292f">i, </span><span style="color:#cf222e">&amp;mut</span><span style="color:#24292f"> i);</span><span style="color:#6e7781"> // 显然不行吧</span></span>
<span class="line"></span></code></pre></div></code></pre><p><s>大家最喜欢的</s> C++ 也是一样的：</p><pre><code class="language-cpp"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#5e81ac;font-weight:700">#</span><span style="color:#81a1c1">include</span><span style="color:#5e81ac"> </span><span style="color:#eceff4">&lt;</span><span style="color:#a3be8c">iostream</span><span style="color:#eceff4">&gt;</span></span>
<span class="line"><span style="color:#5e81ac;font-weight:700">#</span><span style="color:#81a1c1">include</span><span style="color:#5e81ac"> </span><span style="color:#eceff4">&lt;</span><span style="color:#a3be8c">tuple</span><span style="color:#eceff4">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81a1c1">struct</span><span style="color:#d8dEE9FF"> A </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">int</span><span style="color:#d8dEE9FF"> v</span><span style="color:#81a1c1">;</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#88c0d0">A</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">int</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">i</span><span style="color:#eceff4">):</span><span style="color:#d8dEE9FF"> </span><span style="color:#88c0d0">v</span><span style="color:#eceff4">(</span><span style="color:#d8dEE9FF">i</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">        std</span><span style="color:#eceff4">::</span><span style="color:#d8dEE9FF">cout </span><span style="color:#81a1c1">&lt;&lt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">"</span><span style="color:#a3be8c">A(</span><span style="color:#eceff4">"</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&lt;&lt;</span><span style="color:#d8dEE9FF"> i </span><span style="color:#81a1c1">&lt;&lt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">"</span><span style="color:#a3be8c">)</span><span style="color:#eceff4">"</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&lt;&lt;</span><span style="color:#d8dEE9FF"> std</span><span style="color:#eceff4">::</span><span style="color:#d8dEE9FF">endl</span><span style="color:#81a1c1">;</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#eceff4">}</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#88c0d0">~A</span><span style="color:#eceff4">()</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">        std</span><span style="color:#eceff4">::</span><span style="color:#d8dEE9FF">cout </span><span style="color:#81a1c1">&lt;&lt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">"</span><span style="color:#a3be8c">~A(</span><span style="color:#eceff4">"</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&lt;&lt;</span><span style="color:#d8dEE9FF"> v </span><span style="color:#81a1c1">&lt;&lt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">"</span><span style="color:#a3be8c">)</span><span style="color:#eceff4">"</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&lt;&lt;</span><span style="color:#d8dEE9FF"> std</span><span style="color:#eceff4">::</span><span style="color:#d8dEE9FF">endl</span><span style="color:#81a1c1">;</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#eceff4">}</span></span>
<span class="line"><span style="color:#eceff4">}</span><span style="color:#81a1c1">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81a1c1">int</span><span style="color:#d8dEE9FF"> </span><span style="color:#88c0d0">main</span><span style="color:#eceff4">()</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    std</span><span style="color:#eceff4">::</span><span style="color:#d8dEE9FF">tuple</span><span style="color:#81a1c1">&lt;</span><span style="color:#d8dEE9FF">A</span><span style="color:#eceff4">,</span><span style="color:#d8dEE9FF"> A</span><span style="color:#81a1c1">&gt;</span><span style="color:#d8dEE9FF"> t </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span><span style="color:#88c0d0">A</span><span style="color:#eceff4">(</span><span style="color:#b48ead">1</span><span style="color:#eceff4">),</span><span style="color:#d8dEE9FF"> </span><span style="color:#88c0d0">A</span><span style="color:#eceff4">(</span><span style="color:#b48ead">2</span><span style="color:#eceff4">)}</span><span style="color:#81a1c1">;</span></span>
<span class="line"><span style="color:#616e88">  	/*</span></span>
<span class="line"><span style="color:#616e88">  	                      A(1)</span></span>
<span class="line"><span style="color:#616e88">  	                            A(2)</span></span>
<span class="line"><span style="color:#616e88">  	                           ~A(2)</span></span>
<span class="line"><span style="color:#616e88">  	                     ~A(1)</span></span>
<span class="line"><span style="color:#616e88">  	*/</span></span>
<span class="line"><span style="color:#d8dEE9FF">    std</span><span style="color:#eceff4">::</span><span style="color:#d8dEE9FF">cout </span><span style="color:#81a1c1">&lt;&lt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">"</span><span style="color:#a3be8c">---</span><span style="color:#eceff4">"</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">&lt;&lt;</span><span style="color:#d8dEE9FF"> std</span><span style="color:#eceff4">::</span><span style="color:#d8dEE9FF">endl</span><span style="color:#81a1c1">;</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">#include</span><span style="color:#24292f"> </span><span style="color:#0a3069">&lt;iostream&gt;</span></span>
<span class="line"><span style="color:#cf222e">#include</span><span style="color:#24292f"> </span><span style="color:#0a3069">&lt;tuple&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">struct</span><span style="color:#24292f"> </span><span style="color:#953800">A</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">int</span><span style="color:#24292f"> v;</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">A</span><span style="color:#24292f">(</span><span style="color:#cf222e">int</span><span style="color:#24292f"> </span><span style="color:#953800">i</span><span style="color:#24292f">): </span><span style="color:#8250df">v</span><span style="color:#24292f">(i) {</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">std</span><span style="color:#24292f">::cout </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#0a3069">"A("</span><span style="color:#24292f"> </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> i </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#0a3069">")"</span><span style="color:#24292f"> </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#24292f">::endl;</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#8250df">~A</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">        </span><span style="color:#953800">std</span><span style="color:#24292f">::cout </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#0a3069">"~A("</span><span style="color:#24292f"> </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> v </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#0a3069">")"</span><span style="color:#24292f"> </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#24292f">::endl;</span></span>
<span class="line"><span style="color:#24292f">    }</span></span>
<span class="line"><span style="color:#24292f">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">int</span><span style="color:#24292f"> </span><span style="color:#8250df">main</span><span style="color:#24292f">() {</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">std</span><span style="color:#24292f">::tuple</span><span style="color:#cf222e">&lt;</span><span style="color:#24292f">A, A</span><span style="color:#cf222e">&gt;</span><span style="color:#24292f"> t </span><span style="color:#cf222e">=</span><span style="color:#24292f"> {</span><span style="color:#8250df">A</span><span style="color:#24292f">(</span><span style="color:#0550ae">1</span><span style="color:#24292f">), </span><span style="color:#8250df">A</span><span style="color:#24292f">(</span><span style="color:#0550ae">2</span><span style="color:#24292f">)};</span></span>
<span class="line"><span style="color:#6e7781">  	/*</span></span>
<span class="line"><span style="color:#6e7781">  	                      A(1)</span></span>
<span class="line"><span style="color:#6e7781">  	                            A(2)</span></span>
<span class="line"><span style="color:#6e7781">  	                           ~A(2)</span></span>
<span class="line"><span style="color:#6e7781">  	                     ~A(1)</span></span>
<span class="line"><span style="color:#6e7781">  	*/</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#953800">std</span><span style="color:#24292f">::cout </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#0a3069">"---"</span><span style="color:#24292f"> </span><span style="color:#cf222e">&lt;&lt;</span><span style="color:#24292f"> </span><span style="color:#953800">std</span><span style="color:#24292f">::endl;</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>所以只好乖乖地加一个中间变量：</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">r</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">cell</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">borrow_mut</span><span style="color:#eceff4">();</span></span>
<span class="line"><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">values</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">(</span><span style="color:#d8dee9">r</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">iter</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">max</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">cloned</span><span style="color:#eceff4">(),</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">r</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">iter</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">min</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">cloned</span><span style="color:#eceff4">());</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> r </span><span style="color:#cf222e">=</span><span style="color:#24292f"> cell</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">();</span></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> values </span><span style="color:#cf222e">=</span><span style="color:#24292f"> (r</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">max</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">cloned</span><span style="color:#24292f">(), r</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">min</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">cloned</span><span style="color:#24292f">());</span></span>
<span class="line"></span></code></pre></div></code></pre><p>或者，<s>写一个宏</s>（<code>rust-analyzer</code>：礼貌你吗🤬？）：</p><pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#2e3440ff"><code><span class="line"><span style="color:#88c0d0">macro_rules!</span><span style="color:#d8dEE9FF"> </span><span style="color:#88c0d0">with</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#eceff4">(</span><span style="color:#81a1c1">$</span><span style="color:#d8dee9">i</span><span style="color:#81a1c1">:</span><span style="color:#d8dee9">ident</span></span>
<span class="line"><span style="color:#d8dEE9FF">      </span><span style="color:#81a1c1">.$</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">$</span><span style="color:#d8dee9">h</span><span style="color:#81a1c1">:</span><span style="color:#d8dee9">ident</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">(</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">$</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">$</span><span style="color:#d8dee9">e0</span><span style="color:#81a1c1">:</span><span style="color:#d8dee9">expr</span><span style="color:#eceff4">),</span><span style="color:#81a1c1">*</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">)</span><span style="color:#81a1c1">.*</span><span style="color:#616e88"> // 要丢弃的可变引用</span></span>
<span class="line"><span style="color:#d8dEE9FF">      #</span></span>
<span class="line"><span style="color:#d8dEE9FF">      </span><span style="color:#81a1c1">.$</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">$</span><span style="color:#d8dee9">f</span><span style="color:#81a1c1">:</span><span style="color:#d8dee9">ident</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">(</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">$</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">$</span><span style="color:#d8dee9">e1</span><span style="color:#81a1c1">:</span><span style="color:#d8dee9">expr</span><span style="color:#eceff4">),</span><span style="color:#81a1c1">*</span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">)</span><span style="color:#81a1c1">.*</span><span style="color:#616e88"> // 调用链</span></span>
<span class="line"><span style="color:#d8dEE9FF">      </span><span style="color:#81a1c1">$</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">$</span><span style="color:#d8dee9">ty</span><span style="color:#81a1c1">:</span><span style="color:#d8dee9">ty</span><span style="color:#eceff4">)</span><span style="color:#81a1c1">?</span><span style="color:#616e88"> // 可选的类型标注</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#eceff4">)</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=&gt;</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">        </span><span style="color:#eceff4">{</span></span>
<span class="line"><span style="color:#d8dEE9FF">            </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">h</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">$</span><span style="color:#d8dee9">i</span><span style="color:#81a1c1">$</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">.$</span><span style="color:#d8dee9">h</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">$</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">$</span><span style="color:#d8dee9">e0</span><span style="color:#eceff4">),</span><span style="color:#81a1c1">*</span><span style="color:#eceff4">))</span><span style="color:#81a1c1">*</span><span style="color:#eceff4">;</span></span>
<span class="line"><span style="color:#d8dEE9FF">            </span><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">v</span><span style="color:#81a1c1">$</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">$</span><span style="color:#d8dee9">ty</span><span style="color:#eceff4">)</span><span style="color:#81a1c1">?</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">h</span><span style="color:#81a1c1">$</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">.$</span><span style="color:#d8dee9">f</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">$</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">$</span><span style="color:#d8dee9">e1</span><span style="color:#eceff4">),</span><span style="color:#81a1c1">*</span><span style="color:#eceff4">))</span><span style="color:#81a1c1">*</span><span style="color:#eceff4">;</span></span>
<span class="line"><span style="color:#d8dEE9FF">            </span><span style="color:#88c0d0">drop</span><span style="color:#eceff4">(</span><span style="color:#d8dee9">h</span><span style="color:#eceff4">);</span></span>
<span class="line"><span style="color:#d8dEE9FF">            </span><span style="color:#d8dee9">v</span></span>
<span class="line"><span style="color:#d8dEE9FF">        </span><span style="color:#eceff4">}</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#eceff4">};</span></span>
<span class="line"><span style="color:#eceff4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">cell</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> RefCell</span><span style="color:#81a1c1">::</span><span style="color:#88c0d0">new</span><span style="color:#eceff4">(</span><span style="color:#88c0d0">vec!</span><span style="color:#eceff4">[</span><span style="color:#b48ead">1</span><span style="color:#eceff4">,</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">2</span><span style="color:#eceff4">,</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">3</span><span style="color:#eceff4">]);</span></span>
<span class="line"><span style="color:#81a1c1">let</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">values</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">=</span><span style="color:#d8dEE9FF"> </span><span style="color:#eceff4">(</span></span>
<span class="line"><span style="color:#d8dEE9FF">  </span><span style="color:#88c0d0">with!</span><span style="color:#eceff4">(</span><span style="color:#d8dee9">cell</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">borrow_mut</span><span style="color:#eceff4">()</span></span>
<span class="line"><span style="color:#d8dEE9FF">    #</span><span style="color:#616e88"> // 以上是可变的引用，以下是引用上的调用链</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">iter</span><span style="color:#eceff4">()</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">map</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">|</span><span style="color:#d8dee9">a</span><span style="color:#81a1c1">|</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">a</span><span style="color:#d8dEE9FF"> </span><span style="color:#81a1c1">+</span><span style="color:#d8dEE9FF"> </span><span style="color:#b48ead">1</span><span style="color:#eceff4">)</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">sum</span><span style="color:#eceff4">()</span></span>
<span class="line"><span style="color:#d8dEE9FF">    </span><span style="color:#81a1c1">:</span><span style="color:#d8dEE9FF">i32</span><span style="color:#616e88"> // 可选的类型标注</span></span>
<span class="line"><span style="color:#d8dEE9FF">  </span><span style="color:#eceff4">),</span></span>
<span class="line"><span style="color:#d8dEE9FF">  </span><span style="color:#88c0d0">with!</span><span style="color:#eceff4">(</span><span style="color:#d8dee9">cell</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">borrow_mut</span><span style="color:#eceff4">()</span><span style="color:#d8dEE9FF">#</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">iter</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">max</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">cloned</span><span style="color:#eceff4">()),</span></span>
<span class="line"><span style="color:#d8dEE9FF">  </span><span style="color:#88c0d0">with!</span><span style="color:#eceff4">(</span><span style="color:#d8dee9">cell</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">borrow_mut</span><span style="color:#eceff4">()</span><span style="color:#d8dEE9FF">#</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">iter</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">min</span><span style="color:#eceff4">()</span><span style="color:#81a1c1">.</span><span style="color:#88c0d0">cloned</span><span style="color:#eceff4">()),</span></span>
<span class="line"><span style="color:#eceff4">);</span></span>
<span class="line"><span style="color:#88c0d0">println!</span><span style="color:#eceff4">(</span><span style="color:#eceff4">"{</span><span style="color:#a3be8c">:?</span><span style="color:#eceff4">}"</span><span style="color:#eceff4">,</span><span style="color:#d8dEE9FF"> </span><span style="color:#d8dee9">values</span><span style="color:#eceff4">);</span><span style="color:#616e88"> // -&gt; (9, Some(3), Some(1))</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code><span class="line"><span style="color:#8250df">macro_rules!</span><span style="color:#24292f"> </span><span style="color:#8250df">with</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">    (</span><span style="color:#cf222e">$</span><span style="color:#24292f">i</span><span style="color:#cf222e">:</span><span style="color:#24292f">ident</span></span>
<span class="line"><span style="color:#24292f">      </span><span style="color:#cf222e">.$</span><span style="color:#24292f">(</span><span style="color:#cf222e">$</span><span style="color:#24292f">h</span><span style="color:#cf222e">:</span><span style="color:#24292f">ident ( </span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">$</span><span style="color:#24292f">e0</span><span style="color:#cf222e">:</span><span style="color:#24292f">expr),</span><span style="color:#cf222e">*</span><span style="color:#24292f">) )</span><span style="color:#cf222e">.*</span><span style="color:#6e7781"> // 要丢弃的可变引用</span></span>
<span class="line"><span style="color:#24292f">      #</span></span>
<span class="line"><span style="color:#24292f">      </span><span style="color:#cf222e">.$</span><span style="color:#24292f">(</span><span style="color:#cf222e">$</span><span style="color:#24292f">f</span><span style="color:#cf222e">:</span><span style="color:#24292f">ident ( </span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">$</span><span style="color:#24292f">e1</span><span style="color:#cf222e">:</span><span style="color:#24292f">expr),</span><span style="color:#cf222e">*</span><span style="color:#24292f">) )</span><span style="color:#cf222e">.*</span><span style="color:#6e7781"> // 调用链</span></span>
<span class="line"><span style="color:#24292f">      </span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">$</span><span style="color:#24292f">ty</span><span style="color:#cf222e">:</span><span style="color:#24292f">ty)</span><span style="color:#cf222e">?</span><span style="color:#6e7781"> // 可选的类型标注</span></span>
<span class="line"><span style="color:#24292f">    ) </span><span style="color:#cf222e">=&gt;</span><span style="color:#24292f"> {</span></span>
<span class="line"><span style="color:#24292f">        {</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#cf222e">let</span><span style="color:#24292f"> h </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#cf222e">$</span><span style="color:#24292f">i</span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">.$</span><span style="color:#24292f">h(</span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">$</span><span style="color:#24292f">e0),</span><span style="color:#cf222e">*</span><span style="color:#24292f">))</span><span style="color:#cf222e">*</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#cf222e">let</span><span style="color:#24292f"> v</span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">:</span><span style="color:#24292f"> </span><span style="color:#cf222e">$</span><span style="color:#24292f">ty)</span><span style="color:#cf222e">?</span><span style="color:#24292f"> </span><span style="color:#cf222e">=</span><span style="color:#24292f"> h</span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">.$</span><span style="color:#24292f">f(</span><span style="color:#cf222e">$</span><span style="color:#24292f">(</span><span style="color:#cf222e">$</span><span style="color:#24292f">e1),</span><span style="color:#cf222e">*</span><span style="color:#24292f">))</span><span style="color:#cf222e">*</span><span style="color:#24292f">;</span></span>
<span class="line"><span style="color:#24292f">            </span><span style="color:#8250df">drop</span><span style="color:#24292f">(h);</span></span>
<span class="line"><span style="color:#24292f">            v</span></span>
<span class="line"><span style="color:#24292f">        }</span></span>
<span class="line"><span style="color:#24292f">    };</span></span>
<span class="line"><span style="color:#24292f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> cell </span><span style="color:#cf222e">=</span><span style="color:#24292f"> </span><span style="color:#953800">RefCell</span><span style="color:#cf222e">::</span><span style="color:#8250df">new</span><span style="color:#24292f">(</span><span style="color:#8250df">vec!</span><span style="color:#24292f">[</span><span style="color:#0550ae">1</span><span style="color:#24292f">, </span><span style="color:#0550ae">2</span><span style="color:#24292f">, </span><span style="color:#0550ae">3</span><span style="color:#24292f">]);</span></span>
<span class="line"><span style="color:#cf222e">let</span><span style="color:#24292f"> values </span><span style="color:#cf222e">=</span><span style="color:#24292f"> (</span></span>
<span class="line"><span style="color:#24292f">  </span><span style="color:#8250df">with!</span><span style="color:#24292f">(cell</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">    #</span><span style="color:#6e7781"> // 以上是可变的引用，以下是引用上的调用链</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">.</span><span style="color:#8250df">map</span><span style="color:#24292f">(</span><span style="color:#cf222e">|</span><span style="color:#24292f">a</span><span style="color:#cf222e">|</span><span style="color:#24292f"> a </span><span style="color:#cf222e">+</span><span style="color:#24292f"> </span><span style="color:#0550ae">1</span><span style="color:#24292f">)</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">.</span><span style="color:#8250df">sum</span><span style="color:#24292f">()</span></span>
<span class="line"><span style="color:#24292f">    </span><span style="color:#cf222e">:</span><span style="color:#953800">i32</span><span style="color:#6e7781"> // 可选的类型标注</span></span>
<span class="line"><span style="color:#24292f">  ),</span></span>
<span class="line"><span style="color:#24292f">  </span><span style="color:#8250df">with!</span><span style="color:#24292f">(cell</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">()#</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">max</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">cloned</span><span style="color:#24292f">()),</span></span>
<span class="line"><span style="color:#24292f">  </span><span style="color:#8250df">with!</span><span style="color:#24292f">(cell</span><span style="color:#cf222e">.</span><span style="color:#8250df">borrow_mut</span><span style="color:#24292f">()#</span><span style="color:#cf222e">.</span><span style="color:#8250df">iter</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">min</span><span style="color:#24292f">()</span><span style="color:#cf222e">.</span><span style="color:#8250df">cloned</span><span style="color:#24292f">()),</span></span>
<span class="line"><span style="color:#24292f">);</span></span>
<span class="line"><span style="color:#8250df">println!</span><span style="color:#24292f">(</span><span style="color:#0a3069">"{:?}"</span><span style="color:#24292f">, values);</span><span style="color:#6e7781"> // -&gt; (9, Some(3), Some(1))</span></span>
<span class="line"></span></code></pre></div></code></pre></div></section><!--]--></article></main></main><!----><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{}}'</script><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,a=localStorage.getItem("color-schema")||"auto";("dark"===a||e&&"light"!==a)&&document.documentElement.classList.toggle("dark",!0)}()</script><link rel="stylesheet" href="/assets/app.902f5b30.css"><link rel="stylesheet" href="/assets/TheArticle.25f0d059.css"><link rel="stylesheet" href="/assets/rust-postmortem.cbcdf903.css"></body></html>